/**
 * kokopu (https://www.npmjs.com/package/kokopu)
 * @version 2.2.1
 * @author Yoann Le Montagner <yo35@melix.net>
 * @license LGPL-3.0-or-later
 */
!function(f){"object"==typeof exports&&"undefined"!=typeof module?module.exports=f():"function"==typeof define&&define.amd?define([],f):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).kokopu=f()}(function(){return function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var p="function"==typeof require&&require;if(!f&&p)return p(i,!0);if(u)return u(i,!0);throw(p=new Error("Cannot find module '"+i+"'")).code="MODULE_NOT_FOUND",p}p=n[i]={exports:{}},e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){"use strict";exports.WHITE=0,exports.BLACK=1,exports.KING=0,exports.QUEEN=1,exports.ROOK=2,exports.BISHOP=3,exports.KNIGHT=4,exports.PAWN=5,exports.WK=0,exports.BK=1,exports.WQ=2,exports.BQ=3,exports.WR=4,exports.BR=5,exports.WB=6,exports.BB=7,exports.WN=8,exports.BN=9,exports.WP=10,exports.BP=11,exports.EMPTY=-1,exports.INVALID=-2,exports.WHITE_WINS=0,exports.BLACK_WINS=1,exports.DRAW=2,exports.LINE=3,exports.REGULAR_CHESS=0,exports.CHESS960=1,exports.NO_KING=2,exports.WHITE_KING_ONLY=3,exports.BLACK_KING_ONLY=4,exports.ANTICHESS=5,exports.HORDE=6;var RESULT_SYMBOL=["1-0","0-1","1/2-1/2","*"],VARIANT_SYMBOL=["regular","chess960","no-king","white-king-only","black-king-only","antichess","horde"];exports.colorToString=function(color){return"wb"[color]},exports.pieceToString=function(piece){return"kqrbnp"[piece]},exports.figurineToString=function(cp){return"♔♚♕♛♖♜♗♝♘♞♙♟"[cp]},exports.rankToString=function(rank){return"12345678"[rank]},exports.fileToString=function(file){return"abcdefgh"[file]},exports.resultToString=function(result){return RESULT_SYMBOL[result]},exports.variantToString=function(variant){return VARIANT_SYMBOL[variant]},exports.colorFromString=function(color){return""===color?-1:"wb".indexOf(color)},exports.pieceFromString=function(piece){return""===piece?-1:"kqrbnp".indexOf(piece)},exports.figurineFromString=function(cp){return""===cp?-1:"♔♚♕♛♖♜♗♝♘♞♙♟".indexOf(cp)},exports.rankFromString=function(rank){return""===rank?-1:"12345678".indexOf(rank)},exports.fileFromString=function(file){return""===file?-1:"abcdefgh".indexOf(file)},exports.resultFromString=function(result){return RESULT_SYMBOL.indexOf(result)},exports.variantFromString=function(variant){return VARIANT_SYMBOL.indexOf(variant)},exports.squareToString=function(square){return"abcdefgh"[square%16]+"12345678"[Math.floor(square/16)]},exports.squareFromString=function(square){if(!/^[a-h][1-8]$/.test(square))return-1;var file="abcdefgh".indexOf(square[0]);return 16*"12345678".indexOf(square[1])+file},exports.coloredPieceToString=function(cp){return"wb"[cp%2]+"kqrbnp"[Math.floor(cp/2)]},exports.coloredPieceFromString=function(cp){if(!/^[wb][kqrbnp]$/.test(cp))return-1;var color="wb".indexOf(cp[0]);return 2*"kqrbnp".indexOf(cp[1])+color}},{}],2:[function(require,module,Database){"use strict";Database=Database.Database=function(impl,gameCountGetter,gameGetter){this._impl=impl,this._gameCountGetter=gameCountGetter,this._gameGetter=gameGetter};Database.prototype.gameCount=function(){return this._gameCountGetter(this._impl)},Database.prototype.game=function(index){return this._gameGetter(this._impl,index)}},{}],3:[function(require,module,exports){"use strict";function buildMessage(message,offset,tokens){return message.replace(/{(\d+)}/g,function(match,index){return(index=Number(index)+offset)<tokens.length?tokens[index]:match})}(exports.IllegalArgument=function(functionName){this.functionName=functionName}).prototype.toString=function(){return"Illegal argument in function "+this.functionName},(exports.InvalidFEN=function(fen,message){this.fen=fen,this.message=buildMessage(message,2,arguments)}).prototype.toString=function(){return"InvalidFEN -> "+this.message},(exports.InvalidNotation=function(fen,notation,message){this.fen=fen,this.notation=notation,this.message=buildMessage(message,3,arguments)}).prototype.toString=function(){return"InvalidNotation -> "+this.message},(exports.InvalidPGN=function(pgn,index,lineNumber,message){this.pgn=pgn,this.index=index,this.lineNumber=lineNumber,this.message=buildMessage(message,4,arguments)}).prototype.toString=function(){return"InvalidPGN -> [character="+this.index+" line="+this.lineNumber+"] "+this.message}},{}],4:[function(require,module,Game){"use strict";var bt=require("./basetypes"),exception=require("./exception"),i18n=require("./i18n"),asciiImpl=require("./private_game/ascii_impl"),Position=require("./position").Position,Game=Game.Game=function(){this._playerName=[void 0,void 0],this._playerElo=[void 0,void 0],this._playerTitle=[void 0,void 0],this._event=void 0,this._round=void 0,this._date=void 0,this._site=void 0,this._annotator=void 0,this._result=bt.LINE,this._initialPosition=new Position,this._fullMoveNumber=1,this._mainVariationInfo=createVariationInfo(!0)};function sanitizeStringHeader(value){return null==value?void 0:String(value)}function createNodeInfo(moveDescriptor){return{moveDescriptor:moveDescriptor,next:void 0,variations:[],nags:{},tags:{},comment:void 0,isLongComment:!1}}function Node(info,parentVariation,fullMoveNumber,positionBefore){this._info=info,this._parentVariation=parentVariation,this._fullMoveNumber=fullMoveNumber,this._positionBefore=positionBefore}function applyMoveDescriptor(position,info){void 0===info.moveDescriptor?position.playNullMove():position.play(info.moveDescriptor)}function rebuildPositionBeforeIfNecessary(node){if(!node._positionBefore){node._positionBefore=new Position(node._parentVariation._initialPosition);for(var currentInfo=node._parentVariation._info.first;currentInfo!==node._info;){if(void 0===currentInfo)throw new exception.IllegalArgument("The current node is invalid.");applyMoveDescriptor(node._positionBefore,currentInfo),currentInfo=currentInfo.next}}return node._positionBefore}function computePositionBeforeAndFullMoveNumberForNextNode(node){var positionBefore=rebuildPositionBeforeIfNecessary(node);applyMoveDescriptor(positionBefore,node._info);var fullMoveNumber="w"===positionBefore.turn()?node._fullMoveNumber+1:node._fullMoveNumber;return node._positionBefore=null,{positionBefore:positionBefore,fullMoveNumber:fullMoveNumber}}function isValidNag(nag){return"number"==typeof nag&&!isNaN(nag)&&0<=nag}function computeMoveDescriptor(position,move){if("--"!==move)return position.notation(move);if(!position.isNullMoveLegal())throw new exception.InvalidNotation(position,"--",i18n.ILLEGAL_NULL_MOVE)}function createVariationInfo(isLongVariation){return{isLongVariation:isLongVariation,first:void 0,nags:{},tags:{},comment:void 0,isLongComment:!1}}function Variation(info,initialFullMoveNumber,initialPosition,withinLongVariation){this._info=info,this._initialFullMoveNumber=initialFullMoveNumber,this._initialPosition=initialPosition,this._withinLongVariation=withinLongVariation&&info.isLongVariation}Game.prototype.playerName=function(color,value){if((color=bt.colorFromString(color))<0)throw new exception.IllegalArgument("Game#playerName()");if(1===arguments.length)return this._playerName[color];this._playerName[color]=sanitizeStringHeader(value)},Game.prototype.playerElo=function(color,value){if((color=bt.colorFromString(color))<0)throw new exception.IllegalArgument("Game#playerElo()");if(1===arguments.length)return this._playerElo[color];this._playerElo[color]=sanitizeStringHeader(value)},Game.prototype.playerTitle=function(color,value){if((color=bt.colorFromString(color))<0)throw new exception.IllegalArgument("Game#playerTitle()");if(1===arguments.length)return this._playerTitle[color];this._playerTitle[color]=sanitizeStringHeader(value)},Game.prototype.event=function(value){if(0===arguments.length)return this._event;this._event=sanitizeStringHeader(value)},Game.prototype.round=function(value){if(0===arguments.length)return this._round;this._round=sanitizeStringHeader(value)},Game.prototype.date=function(value){if(0===arguments.length)return this._date instanceof Date?new Date(this._date):this._date?Object.assign({},this._date):void 0;if(null==value)this._date=void 0;else if(value instanceof Date)this._date=new Date(value);else if("object"==typeof value&&"number"==typeof value.year&&"number"==typeof value.month&&1<=value.month&&value.month<=12)this._date={year:Math.round(value.year),month:Math.round(value.month)};else{if("object"!=typeof value||"number"!=typeof value.year||void 0!==value.month&&null!==value.month)throw new exception.IllegalArgument("Game#date()");this._date={year:Math.round(value.year)}}},Game.prototype.dateAsString=function(locales){if(this._date){if(this._date instanceof Date)return new Intl.DateTimeFormat(locales,{dateStyle:"long"}).format(this._date);if(this._date.month){var firstDay=new Date(this._date.year,this._date.month-1,1);return new Intl.DateTimeFormat(locales,{month:"long",year:"numeric"}).format(firstDay)}return String(this._date.year)}},Game.prototype.site=function(value){if(0===arguments.length)return this._site;this._site=sanitizeStringHeader(value)},Game.prototype.annotator=function(value){if(0===arguments.length)return this._annotator;this._annotator=sanitizeStringHeader(value)},Game.prototype.result=function(result){if(0===arguments.length)return bt.resultToString(this._result);result=bt.resultFromString(result);if(result<0)throw new exception.IllegalArgument("Game#result()");this._result=result},Game.prototype.variant=function(){return this._initialPosition.variant()},Game.prototype.initialPosition=function(initialPosition,fullMoveNumber){if(0===arguments.length)return this._initialPosition;if(!(initialPosition instanceof Position))throw new exception.IllegalArgument("Game#initialPosition()");if(1===arguments.length)fullMoveNumber=1;else if("number"!=typeof fullMoveNumber)throw new exception.IllegalArgument("Game#initialPosition()");this._initialPosition=initialPosition,this._fullMoveNumber=fullMoveNumber,this._mainVariationInfo=createVariationInfo(!0)},Game.prototype.mainVariation=function(){return new Variation(this._mainVariationInfo,this._fullMoveNumber,this._initialPosition,!0)},Game.prototype.ascii=function(){return asciiImpl.ascii(this)},Node.prototype.notation=function(){return void 0===this._info.moveDescriptor?"--":rebuildPositionBeforeIfNecessary(this).notation(this._info.moveDescriptor)},Node.prototype.figurineNotation=function(){return void 0===this._info.moveDescriptor?"--":rebuildPositionBeforeIfNecessary(this).figurineNotation(this._info.moveDescriptor)},Node.prototype.positionBefore=function(){return new Position(rebuildPositionBeforeIfNecessary(this))},Node.prototype.position=function(){var position=this.positionBefore();return void 0===this._info.moveDescriptor?position.playNullMove():position.play(this._info.moveDescriptor),position},Node.prototype.fullMoveNumber=function(){return this._fullMoveNumber},Node.prototype.moveColor=function(){return rebuildPositionBeforeIfNecessary(this).turn()},Node.prototype.next=function(){if(this._info.next){var next=computePositionBeforeAndFullMoveNumberForNextNode(this);return new Node(this._info.next,this._parentVariation,next.fullMoveNumber,next.positionBefore)}},Node.prototype.variations=function(){if(0===this._info.variations.length)return[];for(var result=[],positionBefore=this.positionBefore(),i=0;i<this._info.variations.length;++i)result.push(new Variation(this._info.variations[i],this._fullMoveNumber,positionBefore,this._parentVariation._withinLongVariation));return result},Node.prototype.nags=function(){var key,result=[];for(key in this._info.nags)result.push(Number(key));return result.sort(function(a,b){return a-b})},Node.prototype.hasNag=function(nag){if(!isValidNag(nag))throw new exception.IllegalArgument("Node#hasNag()");return Boolean(this._info.nags[nag])},Node.prototype.addNag=function(nag){if(!isValidNag(nag))throw new exception.IllegalArgument("Node#addNag()");this._info.nags[nag]=!0},Node.prototype.removeNag=function(nag){if(!isValidNag(nag))throw new exception.IllegalArgument("Node#removeNag()");delete this._info.nags[nag]},Node.prototype.tags=function(){var key,result=[];for(key in this._info.tags)result.push(key);return result.sort()},Node.prototype.tag=function(tagKey,value){if(!/^\w+$/.test(tagKey))throw new exception.IllegalArgument("Node#tag()");if(1===arguments.length)return this._info.tags[tagKey];null==value?delete this._info.tags[tagKey]:this._info.tags[tagKey]=String(value)},Node.prototype.comment=function(value,isLongComment){if(0===arguments.length)return this._info.comment;this._info.comment=sanitizeStringHeader(value),this._info.isLongComment=this._info.comment&&isLongComment},Node.prototype.isLongComment=function(){return this._parentVariation._withinLongVariation&&this._info.isLongComment},Node.prototype.play=function(move){var next=computePositionBeforeAndFullMoveNumberForNextNode(this);return this._info.next=createNodeInfo(computeMoveDescriptor(next.positionBefore,move)),new Node(this._info.next,this._parentVariation,next.fullMoveNumber,next.positionBefore)},Node.prototype.addVariation=function(isLongVariation){return this._info.variations.push(createVariationInfo(isLongVariation)),new Variation(this._info.variations[this._info.variations.length-1],this._fullMoveNumber,this.positionBefore(),this._parentVariation._withinLongVariation)},Variation.prototype.isLongVariation=function(){return this._withinLongVariation},Variation.prototype.initialPosition=function(){return new Position(this._initialPosition)},Variation.prototype.initialFullMoveNumber=function(){return this._initialFullMoveNumber},Variation.prototype.first=function(){if(this._info.first)return new Node(this._info.first,this,this._initialFullMoveNumber,new Position(this._initialPosition))},Variation.prototype.nodes=function(){for(var result=[],currentNodeInfo=this._info.first,previousNodeInfo=null,previousPositionBefore=this._initialPosition,previousFullMoveNumber=this._initialFullMoveNumber;currentNodeInfo;){previousPositionBefore=new Position(previousPositionBefore);null!==previousNodeInfo&&applyMoveDescriptor(previousPositionBefore,previousNodeInfo),previousFullMoveNumber=null!==previousNodeInfo&&"w"===previousPositionBefore.turn()?previousFullMoveNumber+1:previousFullMoveNumber,result.push(new Node(currentNodeInfo,this,previousFullMoveNumber,previousPositionBefore)),currentNodeInfo=(previousNodeInfo=currentNodeInfo).next}return result},Variation.prototype.nags=Node.prototype.nags,Variation.prototype.hasNag=Node.prototype.hasNag,Variation.prototype.addNag=Node.prototype.addNag,Variation.prototype.removeNag=Node.prototype.removeNag,Variation.prototype.tags=Node.prototype.tags,Variation.prototype.tag=Node.prototype.tag,Variation.prototype.comment=Node.prototype.comment,Variation.prototype.isLongComment=function(){return this._withinLongVariation&&this._info.isLongComment},Variation.prototype.play=function(move){var positionBefore=new Position(this._initialPosition);return this._info.first=createNodeInfo(computeMoveDescriptor(positionBefore,move)),new Node(this._info.first,this,this._initialFullMoveNumber,positionBefore)}},{"./basetypes":1,"./exception":3,"./i18n":6,"./position":10,"./private_game/ascii_impl":11}],5:[function(require,module,exports){"use strict";var bt=require("./basetypes"),exception=require("./exception"),impl=require("./private_position/impl");exports.forEachSquare=function(callback){for(var rank=0;rank<8;++rank)for(var file=0;file<8;++file)callback(bt.squareToString(16*rank+file))},exports.squareColor=function(square){if((square=bt.squareFromString(square))<0)throw new exception.IllegalArgument("squareColor()");return Math.floor(square/16)%2==square%2?"b":"w"},exports.squareToCoordinates=function(square){if((square=bt.squareFromString(square))<0)throw new exception.IllegalArgument("squareToCoordinates()");return{rank:Math.floor(square/16),file:square%16}},exports.coordinatesToSquare=function(file,rank){if(file<0||8<=file||rank<0||8<=rank)throw new exception.IllegalArgument("coordinatesToSquare()");return bt.fileToString(file)+bt.rankToString(rank)},exports.oppositeColor=function(color){if((color=bt.colorFromString(color))<0)throw new exception.IllegalArgument("oppositeColor()");return bt.colorToString(1-color)},exports.variantWithCanonicalStartPosition=function(variant){if((variant=bt.variantFromString(variant))<0)throw new exception.IllegalArgument("oppositeColor()");return impl.variantWithCanonicalStartPosition(variant)}},{"./basetypes":1,"./exception":3,"./private_position/impl":18}],6:[function(require,module,exports){"use strict";exports.WRONG_NUMBER_OF_FEN_FIELDS="A FEN string must contain exactly 6 space-separated fields.",exports.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD="The 1st field of a FEN string must contain exactly 8 `/`-separated subfields.",exports.UNEXPECTED_CHARACTER_IN_BOARD_FIELD="Unexpected character in the 1st field of the FEN string: `{0}`.",exports.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD="Subfield {0} of the FEN string 1st field is unexpectedly short.",exports.INVALID_TURN_FIELD="The 2nd field of a FEN string must be either `w` or `b`.",exports.INVALID_CASTLING_FIELD="The 3rd field of a FEN string must be either `-` or a list of characters among `K`, `Q`, `k` and `q` (in this order).",exports.INVALID_EN_PASSANT_FIELD="The 4th field of a FEN string must be either `-` or a square from the 3rd or 6th rank where en-passant is allowed.",exports.WRONG_RANK_IN_EN_PASSANT_FIELD="The rank number indicated in the FEN string 4th field is inconsistent with respect to the 2nd field.",exports.INVALID_HALF_MOVE_COUNT_FIELD="The 5th field of a FEN string must be a number, indicating the number of half-move since the last pawn move or capture.",exports.INVALID_MOVE_NUMBER_FIELD="The 6th field of a FEN string must be a number, indicating the move number of the game.",exports.INVALID_VARIANT_PREFIX="Invalid variant prefix: `{0}`.",exports.INVALID_UCI_NOTATION_SYNTAX="The syntax of the UCI notation is invalid.",exports.ILLEGAL_UCI_MOVE="The UCI move is not legal.",exports.INVALID_MOVE_NOTATION_SYNTAX="The syntax of the move notation is invalid.",exports.ILLEGAL_POSITION="The position is not legal.",exports.ILLEGAL_NO_KING_CASTLING="Casting is not legal in the considered position as it has no king.",exports.ILLEGAL_QUEEN_SIDE_CASTLING="Queen-side castling is not legal in the considered position.",exports.ILLEGAL_KING_SIDE_CASTLING="King-side castling is not legal in the considered position.",exports.NO_PIECE_CAN_MOVE_TO="No {0} can move to {1}.",exports.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION="No {0} on the specified rank/file can move to {1}.",exports.REQUIRE_DISAMBIGUATION="Cannot determine uniquely which {0} is supposed to move to {1}.",exports.WRONG_DISAMBIGUATION_SYMBOL="Wrong disambiguation symbol (expected: `{0}`, observed: `{1}`).",exports.TRYING_TO_CAPTURE_YOUR_OWN_PIECES="Capturing its own pieces is not legal.",exports.CAPTURE_IS_MANDATORY="Capture is mandatory.",exports.INVALID_PIECE_SYMBOL="Character `{0}` is not a valid piece symbol.",exports.INVALID_PIECE_SYMBOL_COLOR="Invalid color for piece symbol `{0}`.",exports.INVALID_CAPTURING_PAWN_MOVE="Invalid capturing pawn move.",exports.INVALID_NON_CAPTURING_PAWN_MOVE="Invalid non-capturing pawn move.",exports.NOT_SAFE_FOR_WHITE_KING="This move would let the white king in check.",exports.NOT_SAFE_FOR_BLACK_KING="This move would let the black king in check.",exports.MISSING_PROMOTION="A promoted piece must be specified for this move.",exports.MISSING_PROMOTION_SYMBOL="Character `=` is required to specify a promoted piece.",exports.INVALID_PROMOTED_PIECE="{0} cannot be specified as a promoted piece.",exports.ILLEGAL_PROMOTION="Specifying a promoted piece is illegal for this move.",exports.ILLEGAL_NULL_MOVE="Cannot play a null-move in this position.",exports.MISSING_CAPTURE_SYMBOL="Capture symbol `x` is missing.",exports.INVALID_CAPTURE_SYMBOL="This move is not a capture move.",exports.WRONG_CHECK_CHECKMATE_SYMBOL="Wrong check/checkmate symbol (expected: `{0}`, observed: `{1}`).",exports.INVALID_PGN_TOKEN="Unrecognized character or group of characters.",exports.INVALID_MOVE_IN_PGN_TEXT="Invalid move ({0}). {1}",exports.INVALID_FEN_IN_PGN_TEXT="Invalid FEN string in the initial position header. {0}",exports.UNEXPECTED_PGN_HEADER="Unexpected PGN game header.",exports.MISSING_PGN_HEADER_ID="Missing or invalid PGN game header ID.",exports.MISSING_PGN_HEADER_VALUE="Missing or invalid PGN game header value.",exports.MISSING_END_OF_PGN_HEADER="Missing or invalid end of PGN game header.",exports.UNEXPECTED_BEGIN_OF_VARIATION="Unexpected begin of variation.",exports.UNEXPECTED_END_OF_VARIATION="Unexpected end of variation.",exports.UNEXPECTED_END_OF_GAME="Unexpected end of game: there are pending variations.",exports.UNEXPECTED_END_OF_TEXT="Unexpected end of text: there is a pending game.",exports.INVALID_GAME_INDEX="Game index {0} is invalid (only {1} game(s) found in the PGN data).",exports.UNKNOWN_VARIANT="Unknown chess game variant ({0}).",exports.VARIANT_WITHOUT_FEN="For game variant {0}, the FEN header is mandatory."},{}],7:[function(pgn,module,exports){"use strict";exports.i18n=pgn("./i18n"),exports.exception=pgn("./exception");var helper=pgn("./helper");exports.forEachSquare=helper.forEachSquare,exports.squareColor=helper.squareColor,exports.squareToCoordinates=helper.squareToCoordinates,exports.coordinatesToSquare=helper.coordinatesToSquare,exports.oppositeColor=helper.oppositeColor,exports.variantWithCanonicalStartPosition=helper.variantWithCanonicalStartPosition,exports.isMoveDescriptor=pgn("./movedescriptor").isMoveDescriptor,exports.Position=pgn("./position").Position,exports.Game=pgn("./game").Game;pgn=pgn("./pgn");exports.pgnRead=pgn.pgnRead,exports.pgnWrite=pgn.pgnWrite},{"./exception":3,"./game":4,"./helper":5,"./i18n":6,"./movedescriptor":8,"./pgn":9,"./position":10}],8:[function(require,module,exports){"use strict";var bt=require("./basetypes"),exception=require("./exception");function MoveDescriptor(flags,from,to,movingPiece,finalPiece,optionalPiece,optionalSquare1,optionalSquare2){this._type=flags,this._from=from,this._to=to,this._movingPiece=movingPiece,this._finalPiece=finalPiece,this._optionalPiece=optionalPiece,this._optionalSquare1=optionalSquare1,this._optionalSquare2=optionalSquare2}exports.make=function(from,to,movingColoredPiece,movingPiece,capturedPiece){movingColoredPiece=2*movingPiece+movingColoredPiece;return new MoveDescriptor(0<=capturedPiece?4:0,from,to,movingColoredPiece,movingColoredPiece,capturedPiece,-1,-1)},exports.makeCastling=function(from,to,rookFrom,rookTo,color){var movingKing=2*bt.KING+color;return new MoveDescriptor(1,from,to,movingKing,movingKing,2*bt.ROOK+color,rookFrom,rookTo)},exports.makeEnPassant=function(from,to,enPassantSquare,color){var movingPawn=2*bt.PAWN+color;return new MoveDescriptor(6,from,to,movingPawn,movingPawn,2*bt.PAWN+1-color,enPassantSquare,-1)},exports.makePromotion=function(from,to,color,promotion,capturedPiece){return new MoveDescriptor(8|(0<=capturedPiece?4:0),from,to,2*bt.PAWN+color,2*promotion+color,capturedPiece,-1,-1)},exports.isMoveDescriptor=function(obj){return obj instanceof MoveDescriptor},MoveDescriptor.prototype.toString=function(){var result=bt.squareToString(this._from)+bt.squareToString(this._to);return this.isPromotion()?result+=this.promotion().toUpperCase():this.isCastling()&&(result+="O"),result},MoveDescriptor.prototype.isCastling=function(){return 0!=(1&this._type)},MoveDescriptor.prototype.isEnPassant=function(){return 0!=(2&this._type)},MoveDescriptor.prototype.isCapture=function(){return 0!=(4&this._type)},MoveDescriptor.prototype.isPromotion=function(){return 0!=(8&this._type)},MoveDescriptor.prototype.from=function(){return bt.squareToString(this._from)},MoveDescriptor.prototype.to=function(){return bt.squareToString(this._to)},MoveDescriptor.prototype.color=function(){return bt.colorToString(this._movingPiece%2)},MoveDescriptor.prototype.movingPiece=function(){return bt.pieceToString(Math.floor(this._movingPiece/2))},MoveDescriptor.prototype.movingColoredPiece=function(){return bt.coloredPieceToString(this._movingPiece)},MoveDescriptor.prototype.capturedPiece=function(){if(!this.isCapture())throw new exception.IllegalArgument("MoveDescriptor#capturedPiece()");return bt.pieceToString(Math.floor(this._optionalPiece/2))},MoveDescriptor.prototype.capturedColoredPiece=function(){if(!this.isCapture())throw new exception.IllegalArgument("MoveDescriptor#capturedColoredPiece()");return bt.coloredPieceToString(this._optionalPiece)},MoveDescriptor.prototype.rookFrom=function(){if(!this.isCastling())throw new exception.IllegalArgument("MoveDescriptor#rookFrom()");return bt.squareToString(this._optionalSquare1)},MoveDescriptor.prototype.rookTo=function(){if(!this.isCastling())throw new exception.IllegalArgument("MoveDescriptor#rookTo()");return bt.squareToString(this._optionalSquare2)},MoveDescriptor.prototype.enPassantSquare=function(){if(!this.isEnPassant())throw new exception.IllegalArgument("MoveDescriptor#enPassantSquare()");return bt.squareToString(this._optionalSquare1)},MoveDescriptor.prototype.promotion=function(){if(!this.isPromotion())throw new exception.IllegalArgument("MoveDescriptor#promotion()");return bt.pieceToString(Math.floor(this._finalPiece/2))},MoveDescriptor.prototype.coloredPromotion=function(){if(!this.isPromotion())throw new exception.IllegalArgument("MoveDescriptor#coloredPromotion()");return bt.coloredPieceToString(this._finalPiece)}},{"./basetypes":1,"./exception":3}],9:[function(require,module,exports){"use strict";var Game=require("./game").Game,pgnReadImpl=require("./private_game/pgn_read_impl"),pgnWriteImpl=require("./private_game/pgn_write_impl");exports.pgnRead=function(){return 1===arguments.length?pgnReadImpl.readDatabase(arguments[0]):pgnReadImpl.readOneGame(arguments[0],arguments[1])},exports.pgnWrite=function(input){return input instanceof Game?pgnWriteImpl.writeGames([input]):pgnWriteImpl.writeGames(input)}},{"./game":4,"./private_game/pgn_read_impl":13,"./private_game/pgn_write_impl":14}],10:[function(require,module,exports){"use strict";var bt=require("./basetypes"),moveDescriptor=require("./movedescriptor"),exception=require("./exception"),i18n=require("./i18n"),impl=require("./private_position/impl"),fen=require("./private_position/fen"),attacks=require("./private_position/attacks"),legality=require("./private_position/legality"),moveGeneration=require("./private_position/movegeneration"),notation=require("./private_position/notation"),uci=require("./private_position/uci"),Position=exports.Position=function(){if(arguments[0]instanceof Position)this._impl=impl.makeCopy(arguments[0]._impl);else if(0===arguments.length||"start"===arguments[0]||"regular"===arguments[0]&&(1===arguments.length||"start"===arguments[1]))this._impl=impl.makeInitial(bt.REGULAR_CHESS);else if("empty"===arguments[0]||"regular"===arguments[0]&&"empty"===arguments[1])this._impl=impl.makeEmpty(bt.REGULAR_CHESS);else if("chess960"===arguments[0]&&"empty"===arguments[1])this._impl=impl.makeEmpty(bt.CHESS960);else if("chess960"===arguments[0]&&"number"==typeof arguments[1]&&0<=arguments[1]&&arguments[1]<=959)this._impl=impl.make960FromScharnagl(arguments[1]);else if("no-king"===arguments[0]&&"empty"===arguments[1])this._impl=impl.makeEmpty(bt.NO_KING);else if("white-king-only"===arguments[0]&&"empty"===arguments[1])this._impl=impl.makeEmpty(bt.WHITE_KING_ONLY);else if("black-king-only"===arguments[0]&&"empty"===arguments[1])this._impl=impl.makeEmpty(bt.BLACK_KING_ONLY);else if("antichess"!==arguments[0]||1!==arguments.length&&"start"!==arguments[1])if("antichess"===arguments[0]&&"empty"===arguments[1])this._impl=impl.makeEmpty(bt.ANTICHESS);else if("horde"!==arguments[0]||1!==arguments.length&&"start"!==arguments[1])if("horde"===arguments[0]&&"empty"===arguments[1])this._impl=impl.makeEmpty(bt.HORDE);else{if("string"!=typeof arguments[0])throw new exception.IllegalArgument("Position()");var variant,separatorIndex=arguments[0].indexOf(":");if("string"==typeof arguments[1]){if(!(0<=(variant=bt.variantFromString(arguments[0]))))throw new exception.IllegalArgument("Position()");this._impl=fen.parseFEN(variant,arguments[1],!1).position}else if(0<=separatorIndex){if(!(0<=(variant=bt.variantFromString(arguments[0].substring(0,separatorIndex)))))throw new exception.InvalidFEN(arguments[0],i18n.INVALID_VARIANT_PREFIX,arguments[0].substring(0,separatorIndex));this._impl=fen.parseFEN(variant,arguments[0].substring(separatorIndex+1),!1).position}else this._impl=fen.parseFEN(bt.REGULAR_CHESS,arguments[0],!1).position}else this._impl=impl.makeInitial(bt.HORDE);else this._impl=impl.makeInitial(bt.ANTICHESS)};Position.prototype.clear=function(v){if(0===arguments.length)this._impl=impl.makeEmpty(bt.REGULAR_CHESS);else{v=bt.variantFromString(v);if(v<0)throw new exception.IllegalArgument("Position#clear()");this._impl=impl.makeEmpty(v)}},Position.prototype.reset=function(){this._impl=impl.makeInitial(bt.REGULAR_CHESS)},Position.prototype.reset960=function(scharnaglCode){this._impl=impl.make960FromScharnagl(scharnaglCode)},Position.prototype.resetAntichess=function(){this._impl=impl.makeInitial(bt.ANTICHESS)},Position.prototype.resetHorde=function(){this._impl=impl.makeInitial(bt.HORDE)},Position.prototype.ascii=function(){return fen.ascii(this._impl)},Position.prototype.fen=function(){if(0===arguments.length)return fen.getFEN(this._impl,0,1);if(1===arguments.length&&"object"==typeof arguments[0]){var fiftyMoveClock="number"==typeof arguments[0].fiftyMoveClock?arguments[0].fiftyMoveClock:0,fullMoveNumber="number"==typeof arguments[0].fullMoveNumber?arguments[0].fullMoveNumber:1,withVariant="boolean"==typeof arguments[0].withVariant&&arguments[0].withVariant,regularFENIfPossible="boolean"==typeof arguments[0].regularFENIfPossible&&arguments[0].regularFENIfPossible;return(withVariant?bt.variantToString(this._impl.variant)+":":"")+fen.getFEN(this._impl,fiftyMoveClock,fullMoveNumber,regularFENIfPossible)}if(1===arguments.length&&"string"==typeof arguments[0]){var result=fen.parseFEN(this._impl.variant,arguments[0],!1);return this._impl=result.position,{fiftyMoveClock:result.fiftyMoveClock,fullMoveNumber:result.fullMoveNumber}}if(2<=arguments.length&&"string"==typeof arguments[0]&&"boolean"==typeof arguments[1]){result=fen.parseFEN(this._impl.variant,arguments[0],arguments[1]);return this._impl=result.position,{fiftyMoveClock:result.fiftyMoveClock,fullMoveNumber:result.fullMoveNumber}}throw new exception.IllegalArgument("Position#fen()")},Position.prototype.variant=function(){return bt.variantToString(this._impl.variant)},Position.prototype.square=function(square,value){if((square=bt.squareFromString(square))<0)throw new exception.IllegalArgument("Position#square()");var cp;if(1===arguments.length)return(cp=this._impl.board[square])<0?"-":bt.coloredPieceToString(cp);if("-"===value)this._impl.board[square]=bt.EMPTY,this._impl.legal=null;else{if((cp=bt.coloredPieceFromString(value))<0)throw new exception.IllegalArgument("Position#square()");this._impl.board[square]=cp,this._impl.legal=null}},Position.prototype.turn=function(turn){if(0===arguments.length)return bt.colorToString(this._impl.turn);turn=bt.colorFromString(turn);if(turn<0)throw new exception.IllegalArgument("Position#turn()");this._impl.turn=turn,this._impl.legal=null},Position.prototype.castling=function(file,value){if(!(this._impl.variant===bt.CHESS960?/^[wb][a-h]$/:/^[wb][qk]$/).test(file))throw new exception.IllegalArgument("Position#castling()");var color=bt.colorFromString(file[0]),file=this._impl.variant===bt.CHESS960?bt.fileFromString(file[1]):"k"===file[1]?7:0;if(1===arguments.length)return 0!=(this._impl.castling[color]&1<<file);value?this._impl.castling[color]|=1<<file:this._impl.castling[color]&=~(1<<file),this._impl.legal=null},Position.prototype.enPassant=function(enPassant){if(0===arguments.length)return this._impl.enPassant<0?"-":bt.fileToString(this._impl.enPassant);if("-"===enPassant)this._impl.enPassant=-1,this._impl.legal=null;else{enPassant=bt.fileFromString(enPassant);if(enPassant<0)throw new exception.IllegalArgument("Position#enPassant()");this._impl.enPassant=enPassant,this._impl.legal=null}},Position.prototype.isAttacked=function(square,byWho){if(square=bt.squareFromString(square),byWho=bt.colorFromString(byWho),square<0||byWho<0)throw new exception.IllegalArgument("Position#isAttacked()");return attacks.isAttacked(this._impl,square,byWho)},Position.prototype.getAttacks=function(square,byWho){if(square=bt.squareFromString(square),byWho=bt.colorFromString(byWho),square<0||byWho<0)throw new exception.IllegalArgument("Position#getAttacks()");return attacks.getAttacks(this._impl,square,byWho).map(bt.squareToString)},Position.prototype.isLegal=function(){return legality.isLegal(this._impl)},Position.prototype.kingSquare=function(square){if((square=bt.colorFromString(square))<0)throw new exception.IllegalArgument("Position#kingSquare()");legality.refreshLegalFlagAndKingSquares(this._impl);square=this._impl.king[square];return!(square<0)&&bt.squareToString(square)},Position.prototype.isCheck=function(){return moveGeneration.isCheck(this._impl)},Position.prototype.isCheckmate=function(){return moveGeneration.isCheckmate(this._impl)},Position.prototype.isStalemate=function(){return moveGeneration.isStalemate(this._impl)},Position.prototype.hasMove=function(){return moveGeneration.hasMove(this._impl)},Position.prototype.moves=function(){return moveGeneration.moves(this._impl)},Position.prototype.isMoveLegal=function(from,to){if(from=bt.squareFromString(from),to=bt.squareFromString(to),from<0||to<0)throw new exception.IllegalArgument("Position#isMoveLegal()");var result=moveGeneration.isMoveLegal(this._impl,from,to);function makeFactory(status,factory){return factory.status=status,factory}if(result){if(moveDescriptor.isMoveDescriptor(result))return makeFactory("regular",function(){return result});if("promotion"!==result.type)throw new exception.IllegalArgument("Position#isMoveLegal()");return makeFactory("promotion",function(builtMoveDescriptor){if(0<=(builtMoveDescriptor=bt.pieceFromString(builtMoveDescriptor))){builtMoveDescriptor=result.build(builtMoveDescriptor);if(builtMoveDescriptor)return builtMoveDescriptor}throw new exception.IllegalArgument("Position#isMoveLegal()")})}return!1},Position.prototype.play=function(move){if("string"!=typeof move){if(moveDescriptor.isMoveDescriptor(move))return moveGeneration.play(this._impl,move),!0;throw new exception.IllegalArgument("Position#play()")}try{return moveGeneration.play(this._impl,notation.parseNotation(this._impl,move,!1)),!0}catch(err){if(err instanceof exception.InvalidNotation)return!1;throw err}},Position.prototype.isNullMoveLegal=function(){return moveGeneration.isNullMoveLegal(this._impl)},Position.prototype.playNullMove=function(){return moveGeneration.playNullMove(this._impl)},Position.prototype.notation=function(){if(1===arguments.length&&moveDescriptor.isMoveDescriptor(arguments[0]))return notation.getNotation(this._impl,arguments[0],"standard");if(1===arguments.length&&"string"==typeof arguments[0])return notation.parseNotation(this._impl,arguments[0],!1,"standard");if(2<=arguments.length&&"string"==typeof arguments[0]&&"boolean"==typeof arguments[1])return notation.parseNotation(this._impl,arguments[0],arguments[1],"standard");throw new exception.IllegalArgument("Position#notation()")},Position.prototype.figurineNotation=function(){if(1===arguments.length&&moveDescriptor.isMoveDescriptor(arguments[0]))return notation.getNotation(this._impl,arguments[0],"figurine");if(1===arguments.length&&"string"==typeof arguments[0])return notation.parseNotation(this._impl,arguments[0],!1,"figurine");if(2<=arguments.length&&"string"==typeof arguments[0]&&"boolean"==typeof arguments[1])return notation.parseNotation(this._impl,arguments[0],arguments[1],"figurine");throw new exception.IllegalArgument("Position#figurineNotation()")},Position.prototype.uci=function(){if(1===arguments.length&&moveDescriptor.isMoveDescriptor(arguments[0]))return uci.getNotation(this._impl,arguments[0],!1);if(2===arguments.length&&moveDescriptor.isMoveDescriptor(arguments[0])&&"boolean"==typeof arguments[1])return uci.getNotation(this._impl,arguments[0],arguments[1]);if(1===arguments.length&&"string"==typeof arguments[0])return uci.parseNotation(this._impl,arguments[0],!1);if(2<=arguments.length&&"string"==typeof arguments[0]&&"boolean"==typeof arguments[1])return uci.parseNotation(this._impl,arguments[0],arguments[1]);throw new exception.IllegalArgument("Position#uci()")}},{"./basetypes":1,"./exception":3,"./i18n":6,"./movedescriptor":8,"./private_position/attacks":16,"./private_position/fen":17,"./private_position/impl":18,"./private_position/legality":19,"./private_position/movegeneration":20,"./private_position/notation":21,"./private_position/uci":22}],11:[function(require,module,exports){"use strict";var helper=require("../helper"),Position=require("../position").Position,common=require("./common");function trimCollapseAndMarkEmpty(text){return""===(text=common.trimAndCollapseSpaces(text))?"<empty>":text}function formatSimpleHeader(key,header){return void 0===header?void 0:key+": "+trimCollapseAndMarkEmpty(header)}function formatPlayer(key,result,playerElo,playerTitle){if(void 0!==result||void 0!==playerElo||void 0!==playerTitle){result=key+": "+(void 0===result?"<undefined>":trimCollapseAndMarkEmpty(result));return void 0!==playerElo&&void 0!==playerTitle?result+=" ("+trimCollapseAndMarkEmpty(playerTitle)+" "+trimCollapseAndMarkEmpty(playerElo)+")":void 0!==playerElo?result+=" ("+trimCollapseAndMarkEmpty(playerElo)+")":void 0!==playerTitle&&(result+=" ("+trimCollapseAndMarkEmpty(playerTitle)+")"),result}}var NAG_SYMBOLS={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+-",16:"±",14:"⩲",10:"=",13:"∞",15:"⩱",17:"∓",19:"-+"};function formatAnnotations(node){for(var result=[],nags=node.nags(),k=0;k<nags.length;++k){var nag=nags[k];result.push(nag in NAG_SYMBOLS?NAG_SYMBOLS[nag]:"$"+nag)}for(var tags=node.tags(),k=0;k<tags.length;++k){var tag=tags[k];result.push(tag+"={"+common.trimAndCollapseSpaces(node.tag(tag))+"}")}var comment=node.comment();return void 0!==comment&&result.push(trimCollapseAndMarkEmpty(comment)),result}exports.ascii=function(game){var lines=[];function pushIfDefined(header){header&&lines.push(header)}pushIfDefined(function(result,round){if(void 0!==result||void 0!==round){result="Event: "+(void 0===result?"<undefined>":trimCollapseAndMarkEmpty(result));return void 0!==round&&(result+=" ("+trimCollapseAndMarkEmpty(round)+")"),result}}(game._event,game._round)),pushIfDefined(formatSimpleHeader("Site",game._site)),pushIfDefined(void 0===(variant=game.dateAsString("en-us"))?void 0:"Date: "+variant),pushIfDefined(formatPlayer("White",game._playerName[0],game._playerElo[0],game._playerTitle[0])),pushIfDefined(formatPlayer("Black",game._playerName[1],game._playerElo[1],game._playerTitle[1])),pushIfDefined(formatSimpleHeader("Annotator",game._annotator));var variant=game._initialPosition.variant();function dumpVariation(variation,indent,indentFirst,hasSomethingAfter){var variationAnnotations=formatAnnotations(variation);0<variationAnnotations.length&&lines.push(indentFirst+variationAnnotations.join(" "));for(var node=variation.first(),atLeastOneVariationInPreviousNode=!1,isFirstNode=!0;node;){atLeastOneVariationInPreviousNode&&lines.push(indent+" |");var nextNode=node.next(),atLeastOneVariationInPreviousNode=function(node,indent,hasSomethingAfter){var move=indent+node.fullMoveNumber()+("w"===node.moveColor()?".":"...")+node.notation(),moveAnnotations=formatAnnotations(node);lines.push(0===moveAnnotations.length?move:move+" "+moveAnnotations.join(" "));for(var variation,variations=node.variations(),atLeastOneNonEmptyVariation=!1,k=0;k<variations.length;++k)((variation=variations[k]).first()||0<variation.nags().length||0<variation.tags().length||void 0!==variation.comment())&&(lines.push(indent+" |"),dumpVariation(variations[k],indent+(hasSomethingAfter?" |  ":"    "),indent+" +- "),atLeastOneNonEmptyVariation=!0);return atLeastOneNonEmptyVariation}(node,isFirstNode&&0===variationAnnotations.length?indentFirst:indent,hasSomethingAfter||nextNode),isFirstNode=!1,node=nextNode}}return"regular"!==variant&&lines.push("Variant: "+variant),helper.variantWithCanonicalStartPosition(variant)&&game._initialPosition.fen()===new Position(variant).fen()||lines.push(game._initialPosition.ascii()),dumpVariation(game.mainVariation(),"","",!1),lines.push(game.result()),lines.join("\n")}},{"../helper":5,"../position":10,"./common":12}],12:[function(require,module,exports){"use strict";exports.trimAndCollapseSpaces=function(text){return text.replace(/^\s+|\s+$/g,"").replace(/\s+/g," ")}},{}],13:[function(require,module,exports){"use strict";var helper=require("../helper"),exception=require("../exception"),i18n=require("../i18n"),Position=require("../position").Position,Game=require("../game").Game,Database=require("../database").Database,TokenStream=require("./tokenstream").TokenStream;function parseNullableHeader(value){return"?"===value?void 0:value}function processHeader(stream,game,initialPositionFactory,key,value,valueCharacterIndex,valueLineIndex){switch(value=value.trim(),key){case"White":game.playerName("w",parseNullableHeader(value));break;case"Black":game.playerName("b",parseNullableHeader(value));break;case"WhiteElo":game.playerElo("w",value);break;case"BlackElo":game.playerElo("b",value);break;case"WhiteTitle":game.playerTitle("w",value);break;case"BlackTitle":game.playerTitle("b",value);break;case"Event":game.event(parseNullableHeader(value));break;case"Round":game.round(parseNullableHeader(value));break;case"Date":game.date(function(value){if(/^([0-9]{4})\.([0-9]{2})\.([0-9]{2})$/.test(value)){var year=RegExp.$1,month=RegExp.$2,day=RegExp.$3;if(year=parseInt(year,10),month=parseInt(month,10),day=parseInt(day,10),1<=month&&month<=12){var daysInMonth=new Date(year,month,0).getDate();return 1<=day&&day<=daysInMonth?new Date(year,month-1,day):{year:year,month:month}}return{year:year}}if(/^([0-9]{4})\.([0-9]{2})\.\?\?$/.test(value)){year=RegExp.$1,month=RegExp.$2;return year=parseInt(year,10),1<=(month=parseInt(month,10))&&month<=12?{year:year,month:month}:{year:year}}if(/^([0-9]{4})(?:\.\?\?\.\?\?)?$/.test(value))return{year:parseInt(RegExp.$1,10)}}(value));break;case"Site":game.site(parseNullableHeader(value));break;case"Annotator":game.annotator(value);break;case"FEN":initialPositionFactory.fen=value,initialPositionFactory.fenTokenCharacterIndex=valueCharacterIndex,initialPositionFactory.fenTokenLineIndex=valueLineIndex;break;case"Variant":if(initialPositionFactory.variant=function(value){return"regular"===(value=value.toLowerCase())||"standard"===value?"regular":"fischerandom"===value||/^chess[ -]?960$/.test(value)?"chess960":/^no[ -]king$/.test(value)?"no-king":/^white[ -]king[ -]only$/.test(value)?"white-king-only":/^black[ -]king[ -]only$/.test(value)?"black-king-only":/^anti[ -]?chess/.test(value)?"antichess":"horde"===value?"horde":void 0}(value),!initialPositionFactory.variant)throw new exception.InvalidPGN(stream.text(),valueCharacterIndex,valueLineIndex,i18n.UNKNOWN_VARIANT,value);initialPositionFactory.variantTokenCharacterIndex=valueCharacterIndex,initialPositionFactory.variantTokenLineIndex=valueLineIndex}}function doParseGame(stream){for(var game=null,node=null,nodeIsVariation=!1,nodeStack=[],initialPositionFactory={};stream.consumeToken();)switch(null===game&&(game=new Game),stream.isMoveTextSection()&&null===node&&(function(stream,game,initialPositionFactory){if(initialPositionFactory.fen)try{var moveCounters=(position=initialPositionFactory.variant?new Position(initialPositionFactory.variant,"empty"):new Position).fen(initialPositionFactory.fen);game.initialPosition(position,moveCounters.fullMoveNumber)}catch(error){throw error instanceof exception.InvalidFEN?new exception.InvalidPGN(stream.text(),initialPositionFactory.fenTokenCharacterIndex,initialPositionFactory.fenTokenLineIndex,i18n.INVALID_FEN_IN_PGN_TEXT,error.message):error}else if(initialPositionFactory.variant){if(!helper.variantWithCanonicalStartPosition(initialPositionFactory.variant))throw new exception.InvalidPGN(stream.text(),initialPositionFactory.variantTokenCharacterIndex,initialPositionFactory.variantTokenLineIndex,i18n.VARIANT_WITHOUT_FEN,initialPositionFactory.variant);var position=new Position(initialPositionFactory.variant,"start");game.initialPosition(position,1)}}(stream,game,initialPositionFactory),node=game.mainVariation(),nodeIsVariation=!0),stream.token()){case TokenStream.BEGIN_HEADER:if(null!==node)throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.UNEXPECTED_PGN_HEADER);if(!stream.consumeToken()||stream.token()!==TokenStream.HEADER_ID)throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.MISSING_PGN_HEADER_ID);var headerId=stream.tokenValue();if(!stream.consumeToken()||stream.token()!==TokenStream.HEADER_VALUE)throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.MISSING_PGN_HEADER_VALUE);var headerValue=stream.tokenValue(),headerValueCharacterIndex=stream.tokenCharacterIndex(),headerValueLineIndex=stream.tokenLineIndex();if(!stream.consumeToken()||stream.token()!==TokenStream.END_HEADER)throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.MISSING_END_OF_PGN_HEADER);processHeader(stream,game,initialPositionFactory,headerId,headerValue,headerValueCharacterIndex,headerValueLineIndex);break;case TokenStream.MOVE_NUMBER:break;case TokenStream.MOVE:try{node=node.play(stream.tokenValue()),nodeIsVariation=!1}catch(error){throw error instanceof exception.InvalidNotation?new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.INVALID_MOVE_IN_PGN_TEXT,error.notation,error.message):error}break;case TokenStream.NAG:node.addNag(stream.tokenValue());break;case TokenStream.COMMENT:var key,tags=stream.tokenValue().tags;for(key in tags)node.tag(key,tags[key]);void 0!==stream.tokenValue().comment&&node.comment(stream.tokenValue().comment,stream.emptyLineFound()||nodeIsVariation&&0===nodeStack.length);break;case TokenStream.BEGIN_VARIATION:if(nodeIsVariation)throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.UNEXPECTED_BEGIN_OF_VARIATION);nodeStack.push(node),node=node.addVariation(stream.emptyLineFound()),nodeIsVariation=!0;break;case TokenStream.END_VARIATION:if(0===nodeStack.length)throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.UNEXPECTED_END_OF_VARIATION);node=nodeStack.pop(),nodeIsVariation=!1;break;case TokenStream.END_OF_GAME:if(0<nodeStack.length)throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.UNEXPECTED_END_OF_GAME);return game.result(stream.tokenValue()),game;default:throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.INVALID_PGN_TOKEN)}throw new exception.InvalidPGN(stream.text(),stream.tokenCharacterIndex(),stream.tokenLineIndex(),i18n.UNEXPECTED_END_OF_TEXT)}function gameCountGetterImpl(impl){return impl.gameLocations.length}function gameGetterImpl(impl,gameIndex){impl.currentGameIndex!==gameIndex&&(impl.stream=new TokenStream(impl.text,impl.gameLocations[gameIndex])),impl.currentGameIndex=-1;var result=doParseGame(impl.stream);return impl.currentGameIndex=gameIndex+1,result}exports.readDatabase=function(pgnString){for(var stream=new TokenStream(pgnString),gameLocations=[];;){var currentLocation=stream.currentLocation();if(!stream.skipGame())break;gameLocations.push(currentLocation)}return new Database({text:pgnString,gameLocations:gameLocations,currentGameIndex:-1},gameCountGetterImpl,gameGetterImpl)},exports.readOneGame=function(pgnString,gameIndex){for(var stream=new TokenStream(pgnString),gameCounter=0;gameCounter<gameIndex;){if(!stream.skipGame())throw new exception.InvalidPGN(pgnString,-1,-1,i18n.INVALID_GAME_INDEX,gameIndex,gameCounter);++gameCounter}return doParseGame(stream)}},{"../database":2,"../exception":3,"../game":4,"../helper":5,"../i18n":6,"../position":10,"./tokenstream":15}],14:[function(require,module,exports){"use strict";var helper=require("../helper"),Position=require("../position").Position,common=require("./common");function escapeHeaderValue(value){return value.replace(/([\\"])/g,"\\$1")}function escapeCommentValue(value){return value.replace(/([\\}])/g,"\\$1")}function formatNullableHeader(value){return(value=void 0!==value?common.trimAndCollapseSpaces(value):value)?escapeHeaderValue(value):"?"}function writeOptionalHeader(key,value){return(value=void 0!==value?common.trimAndCollapseSpaces(value):value)?"["+key+' "'+escapeHeaderValue(value)+'"]\n':""}function writeAnnotations(node,pushToken,skipLine,isHeaderAnnotationOfMainVariation){for(var nags=node.nags(),k=0;k<nags.length;++k)pushToken("$"+nags[k],!1,!1);for(var comment=(comment=node.comment())&&common.trimAndCollapseSpaces(comment),tags=node.tags(),nonEmptyTagFound=!1,tagValues={},k=0;k<tags.length;++k){var tag=tags[k];(tagValue=common.trimAndCollapseSpaces(node.tag(tag).replace(/[[\]]/g,"")))&&(tagValues[tag]=tagValue,nonEmptyTagFound=!0)}if(nonEmptyTagFound||comment){comment&&node.isLongComment()&&!isHeaderAnnotationOfMainVariation&&skipLine(),pushToken("{",!1,!0);for(var tagValue,k=0;k<tags.length;++k)(tagValue=tagValues[tag=tags[k]])&&(pushToken("[%"+tag,!1,!1),escapeCommentValue(tagValue+"]").split(" ").forEach(function(token){pushToken(token,!1,!1)}));return comment&&escapeCommentValue(comment).split(" ").forEach(function(token){pushToken(token,!1,!1)}),pushToken("}",!0,!1),!0}return!1}function writeVariation(variation,pushToken,skipLine,isMainVariation){writeAnnotations(variation,pushToken,skipLine,isMainVariation);for(var currentNode=variation.first(),forceMoveNumber=!0;currentNode;)forceMoveNumber=function(node,forceMoveNumber,pushToken,skipLine){"w"===node.moveColor()?pushToken(node.fullMoveNumber()+".",!1,!1):forceMoveNumber&&pushToken(node.fullMoveNumber()+"...",!1,!1),pushToken(node.notation(),!1,!1);for(var nextForceMoveNumber=writeAnnotations(node,pushToken,skipLine,!1),variations=node.variations(),k=0;k<variations.length;++k){var variation=variations[k];variation.first()&&(variation.isLongVariation()&&skipLine(),pushToken("(",!1,!0),writeVariation(variation,pushToken,skipLine,!1),pushToken(")",!0,!1),nextForceMoveNumber=!0)}return nextForceMoveNumber}(currentNode,forceMoveNumber,pushToken,skipLine),currentNode=currentNode.next()}function writeGame(game){var date,year,result="";result+='[Event "'+formatNullableHeader(game.event())+'"]\n',result+='[Site "'+formatNullableHeader(game.site())+'"]\n',result+='[Date "'+(date=game.date(),year="????",hasFENHeader=variant="??",date instanceof Date?(year=String(date.getFullYear()).padStart(4,"0"),variant=String(date.getMonth()+1).padStart(2,"0"),hasFENHeader=String(date.getDate()).padStart(2,"0")):date&&date.year&&(year=String(date.year).padStart(4,"0"),date.month&&(variant=String(date.month).padStart(2,"0"))),year+"."+variant+"."+hasFENHeader)+'"]\n',result+='[Round "'+formatNullableHeader(game.round())+'"]\n',result+='[White "'+formatNullableHeader(game.playerName("w"))+'"]\n',result+='[Black "'+formatNullableHeader(game.playerName("b"))+'"]\n',result+='[Result "'+game.result()+'"]\n';var variant=game.variant(),hasFENHeader=!helper.variantWithCanonicalStartPosition(variant)||game._initialPosition.fen()!==new Position(variant).fen();result+=writeOptionalHeader("Annotator",game.annotator()),result+=writeOptionalHeader("BlackElo",game.playerElo("b")),result+=writeOptionalHeader("BlackTitle",game.playerTitle("b")),hasFENHeader&&(result+='[FEN "'+game.initialPosition().fen({fullMoveNumber:game.mainVariation().initialFullMoveNumber(),regularFENIfPossible:!0})+'"]\n',result+='[SetUp "1"]\n'),result+=writeOptionalHeader("Variant",function(variant){if("regular"!==variant)return"chess960"===variant?"Fischerandom":"antichess"===variant?"Antichess":"horde"===variant?"Horde":variant}(variant)),result+=writeOptionalHeader("WhiteElo",game.playerElo("w")),result+=writeOptionalHeader("WhiteTitle",game.playerTitle("w")),result+="\n";var currentLine="",avoidNextSpace=!1;function pushToken(token,avoidSpaceBefore,avoidSpaceAfter){0===currentLine.length?currentLine=token:currentLine.length+token.length+(avoidNextSpace||avoidSpaceBefore?0:1)<=80?currentLine+=(avoidNextSpace||avoidSpaceBefore?"":" ")+token:(result+=currentLine+"\n",currentLine=token),avoidNextSpace=avoidSpaceAfter}return writeVariation(game.mainVariation(),pushToken,function(){result+=currentLine+"\n",result+="\n",currentLine="",avoidNextSpace=!1},!0),pushToken(game.result(),!1,!1),result+=currentLine+"\n"}exports.writeGames=function(games){return games.map(writeGame).join("\n")}},{"../helper":5,"../position":10,"./common":12}],15:[function(require,module,TokenStream){"use strict";var exception=require("../exception"),i18n=require("../i18n"),common=require("./common"),TokenStream=TokenStream.TokenStream=function(pgnString,initialLocation){65279===pgnString.codePointAt(0)&&(pgnString=pgnString.substr(1)),this._text=pgnString,this._pos=0,this._lineIndex=1,this._emptyLineFound=!1,this._token=0,this._tokenValue=null,this._tokenCharacterIndex=-1,this._tokenLineIndex=-1,initialLocation&&(this._pos=initialLocation.pos,this._lineIndex=initialLocation.lineIndex),this._matchSpaces=/[ \f\t\v]+/g,this._matchLineBreak=/\r?\n|\r/g,this._matchLineBreak.needIncrementLineIndex=!0,this._matchFastAdvance=/[^ \f\t\v\r\n"{][^ \f\t\v\r\n"{10*]*/g,this._matchBeginHeader=/\[/g,this._matchEndHeader=/\]/g,this._matchHeaderId=/(\w+)/g,this._matchEnterHeaderValue=/"/g,this._matchMoveNumber=/[1-9][0-9]*\.(?:\.\.)?/g,this._matchMove=/(?:O-O(?:-O)?|0-0(?:-0)?|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[+#]?|--/g,this._matchNag=/([!?][!?]?|\+\/?[-=]|[-=]\/?\+|=|inf|~)|\$([1-9][0-9]*)/g,this._matchEnterComment=/\{/g,this._matchBeginVariation=/\(/g,this._matchEndVariation=/\)/g,this._matchEndOfGame=/1-0|0-1|1\/2-1\/2|\*/g,this._headerValueMode=/((?:[^\\"\f\t\v\r\n]|\\[^\f\t\v\r\n])*)"/g,this._headerValueDegradedMode=/[^\r\n]*/g,this._commentMode=/((?:[^\\}]|\\.)*)\}/g,this._commentMode.needIncrementLineIndex=!0};TokenStream.BEGIN_HEADER=1,TokenStream.END_HEADER=2,TokenStream.HEADER_ID=3,TokenStream.HEADER_VALUE=4,TokenStream.MOVE_NUMBER=5,TokenStream.MOVE=6,TokenStream.NAG=7,TokenStream.COMMENT=8,TokenStream.BEGIN_VARIATION=9,TokenStream.END_VARIATION=10,TokenStream.END_OF_GAME=11;function testAtPos(stream,regex){if((void 0===regex.matchedIndex||regex.matchedIndex<stream._pos)&&(regex.lastIndex=stream._pos,regex.matched=regex.exec(stream._text),regex.matchedIndex=null===regex.matched?stream._text.length:regex.matched.index),regex.matchedIndex===stream._pos){if(stream._pos=regex.lastIndex,regex.needIncrementLineIndex)for(var reLineBreak=/\r?\n|\r/g;reLineBreak.exec(regex.matched[0]);)++stream._lineIndex;return 1}}function skipBlanks(stream){for(var newLineCount=0;stream._pos<stream._text.length;)if(!testAtPos(stream,stream._matchSpaces)){if(!testAtPos(stream,stream._matchLineBreak))break;++newLineCount}stream._emptyLineFound=2<=newLineCount}var SPECIAL_NAGS_LOOKUP={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+/=":14,"+=":14,"=":10,"~":13,inf:13,"=/+":15,"=+":15,"-/+":17,"-+":19};TokenStream.prototype.consumeToken=function(){if(skipBlanks(this),this._pos>=this._text.length)return this._tokenCharacterIndex=this._text.length,this._tokenLineIndex=this._lineIndex,!1;if(this._tokenCharacterIndex=this._pos,this._tokenLineIndex=this._lineIndex,testAtPos(this,this._matchMoveNumber))this._token=5,this._tokenValue=null;else if(testAtPos(this,this._matchMove))this._token=6,this._tokenValue=this._matchMove.matched[0];else if(testAtPos(this,this._matchNag))this._token=7,this._tokenValue=void 0===this._matchNag.matched[2]?SPECIAL_NAGS_LOOKUP[this._matchNag.matched[1]]:parseInt(this._matchNag.matched[2],10);else if(testAtPos(this,this._matchEnterComment)){if(!testAtPos(this,this._commentMode))throw new exception.InvalidPGN(this._text,this._pos,this._lineIndex,i18n.INVALID_PGN_TOKEN);this._token=8,this._tokenValue=function(comment){comment=comment.replace(/\\([\\}])/g,"$1");var tags={},comment=comment.replace(/\[%(\w+)\s([^[\]]*)\]/g,function(match,p1,p2){return""!==(p2=common.trimAndCollapseSpaces(p2))&&(tags[p1]=p2)," "});return{comment:comment=""===(comment=common.trimAndCollapseSpaces(comment))?void 0:comment,tags:tags}}(this._commentMode.matched[1])}else if(testAtPos(this,this._matchBeginVariation))this._token=9,this._tokenValue=null;else if(testAtPos(this,this._matchEndVariation))this._token=10,this._tokenValue=null;else if(testAtPos(this,this._matchEndOfGame))this._token=11,this._tokenValue=this._matchEndOfGame.matched[0];else if(testAtPos(this,this._matchBeginHeader))this._token=1,this._tokenValue=null;else if(testAtPos(this,this._matchEndHeader))this._token=2,this._tokenValue=null;else if(testAtPos(this,this._matchHeaderId))this._token=3,this._tokenValue=this._matchHeaderId.matched[1];else{if(!testAtPos(this,this._matchEnterHeaderValue))throw new exception.InvalidPGN(this._text,this._pos,this._lineIndex,i18n.INVALID_PGN_TOKEN);if(!testAtPos(this,this._headerValueMode))throw new exception.InvalidPGN(this._text,this._pos,this._lineIndex,i18n.INVALID_PGN_TOKEN);this._token=4,this._tokenValue=(rawHeaderValue=this._headerValueMode.matched[1],common.trimAndCollapseSpaces(rawHeaderValue.replace(/\\([\\"])/g,"$1")))}var rawHeaderValue;return!0},TokenStream.prototype.skipGame=function(){for(var atLeastOneTokenFound=!1;;){if(skipBlanks(this),this._pos>=this._text.length)return this._tokenCharacterIndex=this._text.length,this._tokenLineIndex=this._lineIndex,atLeastOneTokenFound;if(this._tokenCharacterIndex=this._pos,this._tokenLineIndex=this._lineIndex,atLeastOneTokenFound=!0,testAtPos(this,this._matchEnterComment)){if(!testAtPos(this,this._commentMode))throw new exception.InvalidPGN(this._text,this._pos,this._lineIndex,i18n.INVALID_PGN_TOKEN)}else if(testAtPos(this,this._matchEnterHeaderValue)){if(!testAtPos(this,this._headerValueMode)&&!testAtPos(this,this._headerValueDegradedMode))throw new exception.InvalidPGN(this._text,this._pos,this._lineIndex,i18n.INVALID_PGN_TOKEN)}else{if(testAtPos(this,this._matchEndOfGame))return this._token=11,this._tokenValue=this._matchEndOfGame.matched[0],!0;if(!testAtPos(this,this._matchFastAdvance))throw new exception.InvalidPGN(this._text,this._pos,this._lineIndex,i18n.INVALID_PGN_TOKEN)}}},TokenStream.prototype.text=function(){return this._text},TokenStream.prototype.currentLocation=function(){return{pos:this._pos,lineIndex:this._lineIndex}},TokenStream.prototype.emptyLineFound=function(){return this._emptyLineFound},TokenStream.prototype.token=function(){return this._token},TokenStream.prototype.tokenValue=function(){return this._tokenValue},TokenStream.prototype.tokenLineIndex=function(){return this._tokenLineIndex},TokenStream.prototype.tokenCharacterIndex=function(){return this._tokenCharacterIndex},TokenStream.prototype.isMoveTextSection=function(){return 5<=this._token&&this._token<=11}},{"../exception":3,"../i18n":6,"./common":12}],16:[function(require,module,exports){"use strict";var bt=require("../basetypes"),ATTACK_DIRECTIONS=exports.ATTACK_DIRECTIONS=[[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-17,-16,-15,-1,1,15,16,17],[-16,-1,1,16],[-16,-1,1,16],[-17,-15,15,17],[-17,-15,15,17],[-33,-31,-18,-14,14,18,31,33],[-33,-31,-18,-14,14,18,31,33],[15,17],[-17,-15]];function isAttackedByNonSliding(position,square,nonSlidingAttacker){for(var directions=ATTACK_DIRECTIONS[nonSlidingAttacker],i=0;i<directions.length;++i){var sq=square-directions[i];if(0==(136&sq)&&position.board[sq]===nonSlidingAttacker)return!0}return!1}function isAttackedBySliding(position,square,slidingAttacker,queenAttacker){for(var directions=ATTACK_DIRECTIONS[slidingAttacker],i=0;i<directions.length;++i)for(var sq=square;;){if(0==(136&(sq-=directions[i]))){var cp=position.board[sq];if(cp===bt.EMPTY)continue;if(cp===slidingAttacker||cp===queenAttacker)return!0}break}return!1}function findNonSlidingAttacks(position,square,result,nonSlidingAttacker){for(var directions=ATTACK_DIRECTIONS[nonSlidingAttacker],i=0;i<directions.length;++i){var sq=square-directions[i];0==(136&sq)&&position.board[sq]===nonSlidingAttacker&&result.push(sq)}}function findSlidingAttacks(position,square,result,slidingAttacker,queenAttacker){for(var directions=ATTACK_DIRECTIONS[slidingAttacker],i=0;i<directions.length;++i)for(var sq=square;;){if(0==(136&(sq-=directions[i]))){var cp=position.board[sq];if(cp===bt.EMPTY)continue;cp!==slidingAttacker&&cp!==queenAttacker||result.push(sq)}break}}exports.isAttacked=function(position,square,attackerColor){return isAttackedByNonSliding(position,square,2*bt.KING+attackerColor)||isAttackedByNonSliding(position,square,2*bt.KNIGHT+attackerColor)||isAttackedByNonSliding(position,square,2*bt.PAWN+attackerColor)||isAttackedBySliding(position,square,2*bt.ROOK+attackerColor,2*bt.QUEEN+attackerColor)||isAttackedBySliding(position,square,2*bt.BISHOP+attackerColor,2*bt.QUEEN+attackerColor)},exports.getAttacks=function(position,square,attackerColor){var result=[];return findNonSlidingAttacks(position,square,result,2*bt.KING+attackerColor),findNonSlidingAttacks(position,square,result,2*bt.KNIGHT+attackerColor),findNonSlidingAttacks(position,square,result,2*bt.PAWN+attackerColor),findSlidingAttacks(position,square,result,2*bt.ROOK+attackerColor,2*bt.QUEEN+attackerColor),findSlidingAttacks(position,square,result,2*bt.BISHOP+attackerColor,2*bt.QUEEN+attackerColor),result}},{"../basetypes":1}],17:[function(require,module,exports){"use strict";var bt=require("../basetypes"),exception=require("../exception"),i18n=require("../i18n"),impl=require("./impl");function castlingToString(position,whiteRegularFlags){if(position.variant===bt.CHESS960){if(whiteRegularFlags){var whiteRegularFlags=regularFENCaslingFlagIfPossible(position,bt.WHITE),result=regularFENCaslingFlagIfPossible(position,bt.BLACK);if(!1!==whiteRegularFlags&&!1!==result)return""===whiteRegularFlags&&""===result?"-":whiteRegularFlags.toUpperCase()+result}for(var whiteFlags="",blackFlags="",file=0;file<8;++file)position.castling[bt.WHITE]&1<<file&&(whiteFlags+=bt.fileToString(file)),position.castling[bt.BLACK]&1<<file&&(blackFlags+=bt.fileToString(file));return""===whiteFlags&&""===blackFlags?"-":whiteFlags.toUpperCase()+blackFlags}result="";return 128&position.castling[bt.WHITE]&&(result+="K"),1&position.castling[bt.WHITE]&&(result+="Q"),128&position.castling[bt.BLACK]&&(result+="k"),1&position.castling[bt.BLACK]&&(result+="q"),""===result?"-":result}function regularFENCaslingFlagIfPossible(position,fenFlag){if(0===position.castling[fenFlag])return"";for(var firstSquare=112*fenFlag,lastSquare=112*fenFlag+7,targetKing=2*bt.KING+fenFlag,targetRook=2*bt.ROOK+fenFlag,kingSquare=-1,sq=firstSquare;sq<=lastSquare;++sq)if(position.board[sq]===targetKing){if(!(kingSquare<0))return!1;kingSquare=sq}if(kingSquare<0)return!1;var kingSideMask=1<<kingSquare%16,kingSideMask=position.castling[fenFlag]&~(kingSideMask|(queenSideMask=kingSideMask-1)),queenSideMask=position.castling[fenFlag]&queenSideMask,fenFlag="",rookSquare=-1;if(0!=kingSideMask){for(sq=kingSquare+1;sq<=lastSquare;++sq)if(position.board[sq]===targetRook){if(!(rookSquare<0))return!1;rookSquare=sq}if(rookSquare<0||kingSideMask!=1<<rookSquare%16)return!1;fenFlag+="k"}if(rookSquare=-1,0!=queenSideMask){for(sq=firstSquare;sq<kingSquare;++sq)if(position.board[sq]===targetRook){if(!(rookSquare<0))return!1;rookSquare=sq}if(rookSquare<0||queenSideMask!=1<<rookSquare%16)return!1;fenFlag+="q"}return""!==fenFlag&&fenFlag}function enPassantToString(position){return position.enPassant<0?"-":bt.fileToString(position.enPassant)+(position.turn===bt.WHITE?"6":"3")}exports.ascii=function(position){for(var result="+---+---+---+---+---+---+---+---+\n",r=7;0<=r;--r){for(var f=0;f<8;++f){var cp=position.board[16*r+f];result+="| "+(cp<0?" ":"KkQqRrBbNnPp"[cp])+" "}result+="|\n",result+="+---+---+---+---+---+---+---+---+\n"}return result+=bt.colorToString(position.turn)+" "+castlingToString(position)+" "+enPassantToString(position),position.variant!==bt.REGULAR_CHESS&&(result+=" ("+bt.variantToString(position.variant)+")"),result},exports.getFEN=function(position,fiftyMoveClock,fullMoveNumber,regularFENIfPossible){for(var result="",r=7;0<=r;--r){for(var emptyCount=0,f=0;f<8;++f){var cp=position.board[16*r+f];cp<0?++emptyCount:(0<emptyCount&&(result+=emptyCount,emptyCount=0),result+="KkQqRrBbNnPp"[cp])}0<emptyCount&&(result+=emptyCount),0<r&&(result+="/")}return result+=" "+bt.colorToString(position.turn)+" "+castlingToString(position,regularFENIfPossible)+" "+enPassantToString(position),result+=" "+fiftyMoveClock+" "+fullMoveNumber},exports.parseFEN=function(enPassantField,fen,moveCountingRegExp){var fields=(fen=fen.replace(/^\s+|\s+$/g,"")).split(/\s+/);if(6!==fields.length)throw new exception.InvalidFEN(fen,i18n.WRONG_NUMBER_OF_FEN_FIELDS);var rankFields=fields[0].split("/");if(8!==rankFields.length)throw new exception.InvalidFEN(fen,i18n.WRONG_NUMBER_OF_SUBFIELDS_IN_BOARD_FIELD);var position=impl.makeEmpty(enPassantField);position.legal=null;for(var r=7;0<=r;--r){for(var rankField=rankFields[7-r],i=0,f=0;i<rankField.length&&f<8;){var s=rankField[i],cp="KkQqRrBbNnPp".indexOf(s);if(/^[1-8]$/.test(s))f+=parseInt(s,10);else{if(!(0<=cp))throw new exception.InvalidFEN(fen,i18n.UNEXPECTED_CHARACTER_IN_BOARD_FIELD,s);position.board[16*r+f]=cp,++f}++i}if(i!==rankField.length||8!==f)throw new exception.InvalidFEN(fen,i18n.UNEXPECTED_END_OF_SUBFIELD_IN_BOARD_FIELD,8-r)}if(position.turn=bt.colorFromString(fields[1]),position.turn<0)throw new exception.InvalidFEN(fen,i18n.INVALID_TURN_FIELD);if(position.castling=enPassantField===bt.CHESS960?function(castling,strict,board){var result=[0,0];if("-"===castling)return result;if(!(strict?/^[A-H]{0,2}[a-h]{0,2}$/:/^[A-Ha-h]*|[KQkq]*$/).test(castling))return null;function searchQueenSideRook(color){for(var targetRook=2*bt.ROOK+color,targetKing=2*bt.KING+color,sq=112*color;sq<112*color+8;++sq){if(board[sq]===targetRook)return sq%8;if(board[sq]===targetKing)break}return 0}function searchKingSideRook(color){for(var targetRook=2*bt.ROOK+color,targetKing=2*bt.KING+color,sq=112*color+7;112*color<=sq;--sq){if(board[sq]===targetRook)return sq%8;if(board[sq]===targetKing)break}return 7}0<=castling.indexOf("K")&&(result[bt.WHITE]|=1<<searchKingSideRook(bt.WHITE));0<=castling.indexOf("Q")&&(result[bt.WHITE]|=1<<searchQueenSideRook(bt.WHITE));0<=castling.indexOf("k")&&(result[bt.BLACK]|=1<<searchKingSideRook(bt.BLACK));0<=castling.indexOf("q")&&(result[bt.BLACK]|=1<<searchQueenSideRook(bt.BLACK));for(var file=0;file<8;++file){var s=bt.fileToString(file);0<=castling.indexOf(s.toUpperCase())&&(result[bt.WHITE]|=1<<file),0<=castling.indexOf(s)&&(result[bt.BLACK]|=1<<file)}return result}(fields[2],moveCountingRegExp,position.board):function(castling,strict){var res=[0,0];if("-"===castling)return res;if(!(strict?/^K?Q?k?q?$/:/^[KQkq]*$/).test(castling))return null;0<=castling.indexOf("K")&&(res[bt.WHITE]|=128);0<=castling.indexOf("Q")&&(res[bt.WHITE]|=1);0<=castling.indexOf("k")&&(res[bt.BLACK]|=128);0<=castling.indexOf("q")&&(res[bt.BLACK]|=1);return res}(fields[2],moveCountingRegExp),null===position.castling)throw new exception.InvalidFEN(fen,i18n.INVALID_CASTLING_FIELD);enPassantField=fields[3];if("-"!==enPassantField){if(!/^[a-h][36]$/.test(enPassantField))throw new exception.InvalidFEN(fen,i18n.INVALID_EN_PASSANT_FIELD);if(moveCountingRegExp&&("3"===enPassantField[1]&&position.turn===bt.WHITE||"6"===enPassantField[1]&&position.turn===bt.BLACK))throw new exception.InvalidFEN(fen,i18n.WRONG_RANK_IN_EN_PASSANT_FIELD);position.enPassant=bt.fileFromString(enPassantField[0])}moveCountingRegExp=moveCountingRegExp?/^(?:0|[1-9][0-9]*)$/:/^[0-9]+$/;if(!moveCountingRegExp.test(fields[4]))throw new exception.InvalidFEN(fen,i18n.INVALID_HALF_MOVE_COUNT_FIELD);if(!moveCountingRegExp.test(fields[5]))throw new exception.InvalidFEN(fen,i18n.INVALID_MOVE_NUMBER_FIELD);return{position:position,fiftyMoveClock:parseInt(fields[4],10),fullMoveNumber:parseInt(fields[5],10)}}},{"../basetypes":1,"../exception":3,"../i18n":6,"./impl":18}],18:[function(REGULAR_START_BOARD,module,exports){"use strict";var bt=REGULAR_START_BOARD("../basetypes"),EMPTY=bt.EMPTY,INVALID=bt.INVALID,EMPTY_BOARD=[EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY],REGULAR_START_BOARD=[bt.WR,bt.WN,bt.WB,bt.WQ,bt.WK,bt.WB,bt.WN,bt.WR,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.BR,bt.BN,bt.BB,bt.BQ,bt.BK,bt.BB,bt.BN,bt.BR],START_POSITION_INFO=[{board:REGULAR_START_BOARD,castling:[129,129],king:[4,116]},null,null,null,null,{board:REGULAR_START_BOARD,castling:[0,0],king:[-1,-1]},{board:[bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,bt.WP,bt.WP,EMPTY,EMPTY,bt.WP,bt.WP,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.BR,bt.BN,bt.BB,bt.BQ,bt.BK,bt.BB,bt.BN,bt.BR],castling:[0,129],king:[-1,116]}];exports.variantWithCanonicalStartPosition=function(variant){return null!==START_POSITION_INFO[variant]},exports.makeEmpty=function(variant){return{board:EMPTY_BOARD.slice(),turn:bt.WHITE,castling:[0,0],enPassant:-1,variant:variant,legal:variant===bt.NO_KING,king:[-1,-1]}},exports.makeInitial=function(variant){var info=START_POSITION_INFO[variant];return{board:info.board.slice(),turn:bt.WHITE,castling:info.castling.slice(),enPassant:-1,variant:variant,legal:!0,king:info.king.slice()}},exports.make960FromScharnagl=function(r8){var info=function(scharnaglCode){var scheme=[-1,-1,-1,-1,-1,-1,-1,-1],castling=0,kingFile=-1;function forEachEmpty(fun){for(var emptyIndex=0,file=0;file<8;++file)0<=scheme[file]||(fun(file,emptyIndex),++emptyIndex)}function setAt(piece,target1,target2){forEachEmpty(function(file,emptyIndex){emptyIndex!==target1&&emptyIndex!==target2||(scheme[file]=piece)})}switch(scheme[scharnaglCode%4*2+1]=bt.BISHOP,scharnaglCode=Math.floor(scharnaglCode/4),scheme[scharnaglCode%4*2]=bt.BISHOP,scharnaglCode=Math.floor(scharnaglCode/4),setAt(bt.QUEEN,scharnaglCode%6,-1),scharnaglCode=Math.floor(scharnaglCode/6)){case 0:setAt(bt.KNIGHT,0,1);break;case 1:setAt(bt.KNIGHT,0,2);break;case 2:setAt(bt.KNIGHT,0,3);break;case 3:setAt(bt.KNIGHT,0,4);break;case 4:setAt(bt.KNIGHT,1,2);break;case 5:setAt(bt.KNIGHT,1,3);break;case 6:setAt(bt.KNIGHT,1,4);break;case 7:setAt(bt.KNIGHT,2,3);break;case 8:setAt(bt.KNIGHT,2,4);break;case 9:setAt(bt.KNIGHT,3,4)}return forEachEmpty(function(file,emptyIndex){1===emptyIndex?(scheme[file]=bt.KING,kingFile=file):(scheme[file]=bt.ROOK,castling|=1<<file)}),{scheme:scheme,castling:castling,kingFile:kingFile}}(r8),r1=info.scheme.map(function(piece){return 2*piece+bt.WHITE}),r8=info.scheme.map(function(piece){return 2*piece+bt.BLACK});return{board:[r1[0],r1[1],r1[2],r1[3],r1[4],r1[5],r1[6],r1[7],INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,bt.WP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,EMPTY,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,bt.BP,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,INVALID,r8[0],r8[1],r8[2],r8[3],r8[4],r8[5],r8[6],r8[7]],turn:bt.WHITE,castling:[info.castling,info.castling],enPassant:-1,variant:bt.CHESS960,legal:!0,king:[info.kingFile,112+info.kingFile]}},exports.makeCopy=function(position){return{board:position.board.slice(),turn:position.turn,castling:position.castling.slice(),enPassant:position.enPassant,variant:position.variant,legal:position.legal,king:position.king.slice()}}},{"../basetypes":1}],19:[function(require,module,exports){"use strict";var bt=require("../basetypes"),attacks=require("./attacks");exports.isLegal=function(position){return refreshLegalFlagAndKingSquares(position),position.legal};var refreshLegalFlagAndKingSquares=exports.refreshLegalFlagAndKingSquares=function(position){if(null===position.legal){position.legal=!1;var square3=refreshKingSquare(position,bt.WHITE),square4=refreshKingSquare(position,bt.BLACK);if(square3&&square4){if(position.variant===bt.ANTICHESS){if(!hasAtLeastOnePiece(position,1-position.turn))return}else if(position.variant===bt.HORDE&&position.turn===bt.BLACK&&!hasAtLeastOnePiece(position,bt.WHITE))return;if(!(0<=position.king[1-position.turn]&&attacks.isAttacked(position,position.king[1-position.turn],position.turn))){for(var forbiddenCPWhite1=position.variant===bt.HORDE?bt.INVALID:bt.WP,c=0;c<8;++c){var cp1=position.board[c],cp8=position.board[112+c];if(cp1===forbiddenCPWhite1||cp8===bt.WP||cp1===bt.BP||cp8===bt.BP)return}for(var isCastlingFlagLegalFun=position.variant===bt.CHESS960?isCastlingFlagLegalForChess960:isCastlingFlagLegalForRegularChess,color=0;color<2;++color)if(!isCastlingFlagLegalFun(position,color))return;if(0<=position.enPassant){var square2=16*(6-5*position.turn)+position.enPassant,square3=16*(5-3*position.turn)+position.enPassant,square4=16*(4-position.turn)+position.enPassant;if(position.board[square2]!==bt.EMPTY||position.board[square3]!==bt.EMPTY||position.board[square4]!==2*bt.PAWN+1-position.turn)return}position.legal=!0}}}};function refreshKingSquare(position,color){var target=2*bt.KING+color;if(position.king[color]=-1,position.variant===bt.ANTICHESS)return!0;if(position.variant===bt.NO_KING||position.variant===bt.BLACK_KING_ONLY-color||position.variant===bt.HORDE&&color===bt.WHITE){for(var sq=0;sq<120;sq+=7==(7&sq)?9:1)if(position.board[sq]===target)return!1;return!0}for(sq=0;sq<120;sq+=7==(7&sq)?9:1)if(position.board[sq]===target){if(!(position.king[color]<0))return!(position.king[color]=-1);position.king[color]=sq}return 0<=position.king[color]}function hasAtLeastOnePiece(position,color){for(var sq=0;sq<120;sq+=7==(7&sq)?9:1)if(0<=position.board[sq]&&position.board[sq]%2===color)return 1}function isCastlingFlagLegalForRegularChess(position,color){if(position.king[color]<0)return 0===position.castling[color];var skipOO=0==(128&position.castling[color]),skipOOO=0==(1&position.castling[color]),rookHOK=skipOO||position.board[7+112*color]===2*bt.ROOK+color,rookAOK=skipOOO||position.board[0+112*color]===2*bt.ROOK+color;return(skipOO&&skipOOO||position.board[4+112*color]===2*bt.KING+color)&&rookAOK&&rookHOK}function isCastlingFlagLegalForChess960(position,color){for(var files=[],file=0;file<8;++file)if(0!=(position.castling[color]&1<<file)){if(position.board[file+112*color]!==2*bt.ROOK+color)return;files.push(file)}switch(files.length){case 0:return!0;case 1:return position.king[color]>=112*color&&position.king[color]<=7+112*color;case 2:return position.king[color]>files[0]+112*color&&position.king[color]<files[1]+112*color;default:return!1}}},{"../basetypes":1,"./attacks":16}],20:[function(require,module,exports){"use strict";var bt=require("../basetypes"),moveDescriptor=require("../movedescriptor"),attacks=require("./attacks"),legality=require("./legality"),DISPLACEMENT_LOOKUP=[204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,0,768,2255,2111,2255,768,0,0,0,0,0,0,60,60,60,60,60,60,63,0,63,60,60,60,60,60,60,0,0,0,0,0,0,768,1231,1087,1231,768,0,0,0,0,0,0,0,0,0,0,0,204,768,60,768,204,0,0,0,0,0,0,0,0,0,0,204,0,0,60,0,0,204,0,0,0,0,0,0,0,0,204,0,0,0,60,0,0,0,204,0,0,0,0,0,0,204,0,0,0,0,60,0,0,0,0,204,0,0,0,0,204,0,0,0,0,0,60,0,0,0,0,0,204,0,0,204,0,0,0,0,0,0,60,0,0,0,0,0,0,204,0],SLIDING_DIRECTION=[-17,0,0,0,0,0,0,-16,0,0,0,0,0,0,-15,0,0,-17,0,0,0,0,0,-16,0,0,0,0,0,-15,0,0,0,0,-17,0,0,0,0,-16,0,0,0,0,-15,0,0,0,0,0,0,-17,0,0,0,-16,0,0,0,-15,0,0,0,0,0,0,0,0,-17,0,0,-16,0,0,-15,0,0,0,0,0,0,0,0,0,0,-17,0,-16,0,-15,0,0,0,0,0,0,0,0,0,0,0,0,-17,-16,-15,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,15,16,17,0,0,0,0,0,0,0,0,0,0,0,0,15,0,16,0,17,0,0,0,0,0,0,0,0,0,0,15,0,0,16,0,0,17,0,0,0,0,0,0,0,0,15,0,0,0,16,0,0,0,17,0,0,0,0,0,0,15,0,0,0,0,16,0,0,0,0,17,0,0,0,0,15,0,0,0,0,0,16,0,0,0,0,0,17,0,0,15,0,0,0,0,0,0,16,0,0,0,0,0,0,17,0];function hasAtLeastOnePiece(position,color){for(var sq=0;sq<120;sq+=7==(7&sq)?9:1)if(position.board[sq]!==bt.EMPTY&&position.board[sq]%2===color)return!0;return!1}function isKingToMoveAttacked(position){return 0<=position.king[position.turn]&&attacks.isAttacked(position,position.king[position.turn],1-position.turn)}exports.isCheck=function(position){return legality.isLegal(position)&&isKingToMoveAttacked(position)},exports.isCheckmate=function(position){return!(!legality.isLegal(position)||hasMove(position))&&(position.variant===bt.ANTICHESS||(position.variant===bt.HORDE&&position.turn===bt.WHITE?!hasAtLeastOnePiece(position,bt.WHITE):isKingToMoveAttacked(position)))},exports.isStalemate=function(position){return!(!legality.isLegal(position)||hasMove(position))&&(position.variant===bt.ANTICHESS||(position.variant===bt.HORDE&&position.turn===bt.WHITE?hasAtLeastOnePiece(position,bt.WHITE):!isKingToMoveAttacked(position)))};var hasMove=exports.hasMove=function(position){function MoveFound(){}try{return generateMoves(position,function(descriptor){if(descriptor)throw new MoveFound}),!1}catch(err){if(err instanceof MoveFound)return!0;throw err}};function generateMoves(position,fun){if(legality.isLegal(position))for(var nonCaptureIsAllowed=!isCaptureMandatory(position),from=0;from<120;from+=7==(7&from)?9:1){var fromContent=position.board[from],movingPiece=Math.floor(fromContent/2);if(!(fromContent<0||fromContent%2!==position.turn)){if(movingPiece===bt.PAWN){for(var moveDirection,firstSquareOfArea,attackDirections=attacks.ATTACK_DIRECTIONS[fromContent],i=0;i<attackDirections.length;++i)0==(136&(to=from+attackDirections[i]))&&(0<=(toContent=position.board[to])&&toContent%2!==position.turn?fun(isKingSafeAfterMove(position,from,to,-1),to<8||112<=to):toContent<0&&to===16*(5-3*position.turn)+position.enPassant&&fun(isKingSafeAfterMove(position,from,to,16*(4-position.turn)+position.enPassant),!1));nonCaptureIsAllowed&&(moveDirection=16-32*position.turn,position.board[to=from+moveDirection]<0&&(fun(isKingSafeAfterMove(position,from,to,-1),to<8||112<=to),(firstSquareOfArea=96*position.turn)<=from&&from<24+firstSquareOfArea&&(to+=moveDirection,position.board[to]<0&&fun(isKingSafeAfterMove(position,from,to,-1),!1))))}else if(movingPiece===bt.KNIGHT||movingPiece===bt.KING)for(var directions=attacks.ATTACK_DIRECTIONS[fromContent],i=0;i<directions.length;++i)0==(136&(to=from+directions[i]))&&((toContent=position.board[to])<0?nonCaptureIsAllowed:toContent%2!==position.turn)&&fun(isKingSafeAfterMove(position,from,to,-1),!1);else for(directions=attacks.ATTACK_DIRECTIONS[fromContent],i=0;i<directions.length;++i)for(var toContent,to=from+directions[i];0==(136&to);to+=directions[i])if(((toContent=position.board[to])<0?nonCaptureIsAllowed:toContent%2!==position.turn)&&fun(isKingSafeAfterMove(position,from,to,-1),!1),0<=toContent)break;if(movingPiece===bt.KING&&nonCaptureIsAllowed&&0!==position.castling[position.turn])if(position.variant===bt.CHESS960)for(var file=0;file<8;++file)fun(isCastlingLegal(position,from,file+112*position.turn),!1);else fun(isCastlingLegal(position,from,2+112*position.turn),!1),fun(isCastlingLegal(position,from,6+112*position.turn),!1)}}}exports.moves=function(position){var res=[];return generateMoves(position,function(descriptor,generatePromotions){descriptor&&(generatePromotions?(res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.QUEEN,descriptor._optionalPiece)),res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.ROOK,descriptor._optionalPiece)),res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.BISHOP,descriptor._optionalPiece)),res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.KNIGHT,descriptor._optionalPiece)),position.variant===bt.ANTICHESS&&res.push(moveDescriptor.makePromotion(descriptor._from,descriptor._to,position.turn,bt.KING,descriptor._optionalPiece))):res.push(descriptor))}),res};var isCaptureMandatory=exports.isCaptureMandatory=function(position){if(position.variant!==bt.ANTICHESS)return!1;for(var sq=0;sq<120;sq+=7==(7&sq)?9:1){var content=position.board[sq];if(0<=content&&content%2!==position.turn&&attacks.isAttacked(position,sq,position.turn))return!0}if(0<=position.enPassant){var enPassantSquare=16*(4-position.turn)+position.enPassant,pawnTarget=2*bt.PAWN+position.turn;if(0==(enPassantSquare-1&136)&&position.board[enPassantSquare-1]===pawnTarget)return!0;if(0==(enPassantSquare+1&136)&&position.board[enPassantSquare+1]===pawnTarget)return!0}return!1},isKingSafeAfterMove=exports.isKingSafeAfterMove=function(position,from,to,enPassantSquare){var fromContent=position.board[from],toContent=position.board[to],movingPiece=Math.floor(fromContent/2),kingIsInCheck=!1;return 0<=position.king[position.turn]&&(position.board[to]=fromContent,position.board[from]=bt.EMPTY,0<=enPassantSquare&&(position.board[enPassantSquare]=bt.EMPTY),kingIsInCheck=attacks.isAttacked(position,movingPiece===bt.KING?to:position.king[position.turn],1-position.turn),position.board[from]=fromContent,position.board[to]=toContent,0<=enPassantSquare&&(position.board[enPassantSquare]=2*bt.PAWN+1-position.turn)),!kingIsInCheck&&(0<=enPassantSquare?moveDescriptor.makeEnPassant(from,to,enPassantSquare,position.turn):moveDescriptor.make(from,to,position.turn,movingPiece,toContent))},isCastlingLegal=exports.isCastlingLegal=function(position,from,to){var rookFrom=-1,rookTo=-1;if(position.variant===bt.CHESS960){var castleFile=to%16;if(Math.floor(to/16)!==7*position.turn||0==(position.castling[position.turn]&1<<castleFile))return!1;rookTo=((rookFrom=to)<from?3:5)+112*position.turn,to=(to<from?2:6)+112*position.turn}else if(to===2+112*position.turn){if(0==(1&position.castling[position.turn]))return!1;rookFrom=112*position.turn,rookTo=3+112*position.turn}else{if(to!==6+112*position.turn)return!1;if(0==(128&position.castling[position.turn]))return!1;rookFrom=7+112*position.turn,rookTo=5+112*position.turn}for(var sq=Math.min(from,to,rookFrom,rookTo);sq<=Math.max(from,to,rookFrom,rookTo);++sq)if(sq!==from&&sq!==rookFrom&&position.board[sq]!==bt.EMPTY)return!1;for(var byWho=1-position.turn,sq=Math.min(from,to);sq<=Math.max(from,to);++sq)if(attacks.isAttacked(position,sq,byWho))return!1;return moveDescriptor.makeCastling(from,to,rookFrom,rookTo,position.turn)};exports.isMoveLegal=function(position,from,to){if(!legality.isLegal(position))return!1;var firstSquareOfArea=position.board[from],toContent=position.board[to],movingPiece=Math.floor(firstSquareOfArea/2);if(firstSquareOfArea<0||firstSquareOfArea%2!==position.turn)return!1;var displacement=to-from+119,enPassantSquare=-1,isTwoSquarePawnMove=!1,isPromotion=movingPiece===bt.PAWN&&(to<8||112<=to),captureIsMandatory=isCaptureMandatory(position);if(movingPiece===bt.KING&&!captureIsMandatory&&0!==position.castling[position.turn]){var castlingDescriptor=isCastlingLegal(position,from,to);if(castlingDescriptor)return castlingDescriptor}if(0==(DISPLACEMENT_LOOKUP[displacement]&1<<firstSquareOfArea)){if(movingPiece!==bt.PAWN||displacement!=151-64*position.turn)return!1;firstSquareOfArea=96*position.turn;if(from<firstSquareOfArea||24+firstSquareOfArea<=from)return!1;isTwoSquarePawnMove=!0}if(movingPiece===bt.PAWN){if(displacement==135-32*position.turn||isTwoSquarePawnMove){if(captureIsMandatory||toContent!==bt.EMPTY)return!1}else if(toContent===bt.EMPTY){if(to!==16*(5-3*position.turn)+position.enPassant)return!1;enPassantSquare=16*(4-position.turn)+position.enPassant}else if(toContent%2===position.turn)return!1}else if(toContent<0?captureIsMandatory:toContent%2===position.turn)return!1;if(movingPiece===bt.BISHOP||movingPiece===bt.ROOK||movingPiece===bt.QUEEN){for(var direction=SLIDING_DIRECTION[displacement],sq=from+direction;sq!==to;sq+=direction)if(position.board[sq]!==bt.EMPTY)return!1}else if(isTwoSquarePawnMove&&position.board[(from+to)/2]!==bt.EMPTY)return!1;var descriptor=isKingSafeAfterMove(position,from,to,enPassantSquare);return descriptor&&isPromotion?{type:"promotion",build:function(promotion){return promotion!==bt.PAWN&&(promotion!==bt.KING||position.variant===bt.ANTICHESS)&&moveDescriptor.makePromotion(descriptor._from,descriptor._to,descriptor._movingPiece%2,promotion,descriptor._optionalPiece)}}:descriptor},exports.play=function(position,descriptor){position.board[descriptor._from]=bt.EMPTY,descriptor.isEnPassant()?position.board[descriptor._optionalSquare1]=bt.EMPTY:descriptor.isCastling()&&(position.board[descriptor._optionalSquare1]=bt.EMPTY,position.board[descriptor._optionalSquare2]=descriptor._optionalPiece),position.board[descriptor._to]=descriptor._finalPiece;var otherPawn,squareBefore,squareAfter,movingPiece=Math.floor(descriptor._movingPiece/2);movingPiece===bt.KING&&(position.castling[position.turn]=0),descriptor._from<8&&(position.castling[bt.WHITE]&=~(1<<descriptor._from)),descriptor._to<8&&(position.castling[bt.WHITE]&=~(1<<descriptor._to)),112<=descriptor._from&&(position.castling[bt.BLACK]&=~(1<<descriptor._from%16)),112<=descriptor._to&&(position.castling[bt.BLACK]&=~(1<<descriptor._to%16)),position.enPassant=-1,movingPiece===bt.PAWN&&32===Math.abs(descriptor._from-descriptor._to)&&(squareAfter=16*(1+5*position.turn),descriptor._from>=squareAfter&&squareAfter<8+squareAfter&&(otherPawn=1^descriptor._movingPiece,squareBefore=descriptor._to-1,squareAfter=descriptor._to+1,(0==(136&squareBefore)&&position.board[squareBefore]===otherPawn||0==(136&squareAfter)&&position.board[squareAfter]===otherPawn)&&(position.enPassant=descriptor._to%16))),movingPiece===bt.KING&&0<=position.king[position.turn]&&(position.king[position.turn]=descriptor._to),position.turn=1-position.turn};var isNullMoveLegal=exports.isNullMoveLegal=function(position){return legality.isLegal(position)&&!isKingToMoveAttacked(position)};exports.playNullMove=function(position){return!!isNullMoveLegal(position)&&(position.turn=1-position.turn,position.enPassant=-1,!0)}},{"../basetypes":1,"../movedescriptor":8,"./attacks":16,"./legality":19}],21:[function(require,module,exports){"use strict";var bt=require("../basetypes"),moveDescriptor=require("../movedescriptor"),exception=require("../exception"),i18n=require("../i18n"),impl=require("./impl"),fen=require("./fen"),attacks=require("./attacks"),legality=require("./legality"),moveGeneration=require("./movegeneration");function getPieceSymbol(coloredPiece,pieceStyle){return"figurine"!==pieceStyle?bt.pieceToString(Math.floor(coloredPiece/2)).toUpperCase():bt.figurineToString(coloredPiece)}function getCheckCheckmateSymbol(nextPosition,descriptor){nextPosition=impl.makeCopy(nextPosition);return moveGeneration.play(nextPosition,descriptor),moveGeneration.isCheckmate(nextPosition)?"#":moveGeneration.isCheck(nextPosition)?"+":""}function getDisambiguationSymbol(position,from,to){var attackers=attacks.getAttacks(position,to,position.turn).filter(function(sq){return position.board[sq]===position.board[from]});if(attackers.length<2)return"";for(var foundNotPined=!1,foundOnSameRank=!1,foundOnSameFile=!1,rankFrom=Math.floor(from/16),fileFrom=from%16,i=0;i<attackers.length;++i){var sq=attackers[i];sq===from||function(position,sq,pinnerBishop){var kingSquare=position.king[position.turn];if(kingSquare<0)return!1;var vector=Math.abs(kingSquare-sq),aimingAtVector=Math.abs(pinnerBishop-sq),pinnerQueen=2*bt.QUEEN+1-position.turn,pinnerRook=2*bt.ROOK+1-position.turn,pinnerBishop=2*bt.BISHOP+1-position.turn;return vector<8?8<=aimingAtVector&&pinningLoockup(position,kingSquare,sq,kingSquare<sq?1:-1,pinnerRook,pinnerQueen):vector%16==0?aimingAtVector%16!=0&&pinningLoockup(position,kingSquare,sq,kingSquare<sq?16:-16,pinnerRook,pinnerQueen):vector%15==0?aimingAtVector%15!=0&&pinningLoockup(position,kingSquare,sq,kingSquare<sq?15:-15,pinnerBishop,pinnerQueen):vector%17==0&&(aimingAtVector%17!=0&&pinningLoockup(position,kingSquare,sq,kingSquare<sq?17:-17,pinnerBishop,pinnerQueen))}(position,sq,to)||(foundNotPined=!0,rankFrom===Math.floor(sq/16)&&(foundOnSameRank=!0),fileFrom==sq%16&&(foundOnSameFile=!0))}return foundOnSameFile?foundOnSameRank?bt.squareToString(from):bt.rankToString(rankFrom):foundNotPined?bt.fileToString(fileFrom):""}function pinningLoockup(position,kingSquare,targetSquare,direction,pinnerColoredPiece1,pinnerColoredPiece2){for(var sq=kingSquare+direction;sq!==targetSquare;sq+=direction)if(position.board[sq]!==bt.EMPTY)return!1;for(sq=targetSquare+direction;0==(136&sq);sq+=direction)if(position.board[sq]!==bt.EMPTY)return position.board[sq]===pinnerColoredPiece1||position.board[sq]===pinnerColoredPiece2;return!1}function parsePieceSymbol(position,notation,coloredPiece,strict,pieceStyle){if("figurine"===pieceStyle){coloredPiece=bt.figurineFromString(coloredPiece);if(piece<0)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_PIECE_SYMBOL,coloredPiece);if(strict&&coloredPiece%2!==position.turn)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_PIECE_SYMBOL_COLOR,coloredPiece);return Math.floor(coloredPiece/2)}var piece=bt.pieceFromString(coloredPiece.toLowerCase());if(piece<0)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_PIECE_SYMBOL,coloredPiece);return piece}exports.getNotation=function(position,descriptor,pieceStyle){var res="";return descriptor.isCastling()?res=descriptor._to%16==6?"O-O":"O-O-O":Math.floor(descriptor._movingPiece/2)===bt.PAWN?(descriptor.isCapture()&&(res+=bt.fileToString(descriptor._from%16)+"x"),res+=bt.squareToString(descriptor._to),descriptor.isPromotion()&&(res+="="+getPieceSymbol(descriptor._finalPiece,pieceStyle))):(res+=getPieceSymbol(descriptor._movingPiece,pieceStyle),res+=getDisambiguationSymbol(position,descriptor._from,descriptor._to),descriptor.isCapture()&&(res+="x"),res+=bt.squareToString(descriptor._to)),res+=getCheckCheckmateSymbol(position,descriptor)},exports.parseNotation=function(position,notation,expectedCCS,promotion){var m=/^(?:(O-O-O|0-0-0)|(O-O|0-0)|([A-Z\u2654-\u265f])([a-h])?([1-8])?(x)?([a-h][1-8])|(?:([a-h])(x)?)?([a-h][1-8])(?:(=)?([A-Z\u2654-\u265f]))?)([+#])?$/.exec(notation);if(null===m)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_MOVE_NOTATION_SYNTAX);if(!legality.isLegal(position))throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_POSITION);var descriptor=null;if(m[1]||m[2]){var observedDS=position.king[position.turn];if(observedDS<0)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_NO_KING_CASTLING);var expectedDS=function(position,isKingSideCastling){{if(position.variant!==bt.CHESS960)return isKingSideCastling?6:2;if(0!==position.castling[position.turn])for(var castlingKing=2*bt.KING+position.turn,file=isKingSideCastling?7:0;position.board[file+112*position.turn]!==castlingKing;file+=isKingSideCastling?-1:1)if(0!=(position.castling[position.turn]&1<<file))return file;return-1}}(position,m[2]);if(!(descriptor=!(expectedDS<0)&&moveGeneration.isCastlingLegal(position,observedDS,expectedDS+112*position.turn))){var observedCCS=m[2]?i18n.ILLEGAL_KING_SIDE_CASTLING:i18n.ILLEGAL_QUEEN_SIDE_CASTLING;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,observedCCS)}}else if(m[3]){var movingPiece=parsePieceSymbol(position,notation,m[3],expectedCCS,promotion),to=bt.squareFromString(m[7]),observedDS=position.board[to];if(0<=observedDS&&observedDS%2===position.turn)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.TRYING_TO_CAPTURE_YOUR_OWN_PIECES);if(observedDS<0&&moveGeneration.isCaptureMandatory(position))throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.CAPTURE_IS_MANDATORY);var fileFrom,rankFrom,attackers=attacks.getAttacks(position,to,position.turn).filter(function(sq){return position.board[sq]===2*movingPiece+position.turn});if(m[4]&&(fileFrom=bt.fileFromString(m[4]),attackers=attackers.filter(function(sq){return sq%16===fileFrom})),m[5]&&(rankFrom=bt.rankFromString(m[5]),attackers=attackers.filter(function(sq){return Math.floor(sq/16)===rankFrom})),0===attackers.length){observedCCS=m[4]||m[5]?i18n.NO_PIECE_CAN_MOVE_TO_DISAMBIGUATION:i18n.NO_PIECE_CAN_MOVE_TO;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,observedCCS,m[3],m[7])}for(var i=0;i<attackers.length;++i){var currentDescriptor=moveGeneration.isKingSafeAfterMove(position,attackers[i],to,-1);if(currentDescriptor){if(null!==descriptor)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.REQUIRE_DISAMBIGUATION,m[3],m[7]);descriptor=currentDescriptor}}if(null===descriptor){observedCCS=position.turn===bt.WHITE?i18n.NOT_SAFE_FOR_WHITE_KING:i18n.NOT_SAFE_FOR_BLACK_KING;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,observedCCS)}if(expectedCCS){expectedDS=getDisambiguationSymbol(position,descriptor._from,to),observedDS=(m[4]||"")+(m[5]||"");if(expectedDS!==observedDS)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.WRONG_DISAMBIGUATION_SYMBOL,expectedDS,observedDS)}}else if(m[10]){to=bt.squareFromString(m[10]);if(m[8])descriptor=function(position,notation,toContent,to){var from=to-16+32*position.turn;if(0!=(136&from))throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE);var columnTo=to%16;if(columnTo-toContent==1)--from;else{if(columnTo-toContent!=-1)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE);from+=1}if(position.board[from]!==2*bt.PAWN+position.turn)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE);toContent=position.board[to];if(toContent<0){if(to===16*(5-3*position.turn)+position.enPassant)return moveGeneration.isKingSafeAfterMove(position,from,to,16*(4-position.turn)+position.enPassant)}else if(toContent%2!==position.turn)return moveGeneration.isKingSafeAfterMove(position,from,to,-1);throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_CAPTURING_PAWN_MOVE)}(position,notation,bt.fileFromString(m[8]),to);else{if(moveGeneration.isCaptureMandatory(position))throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.CAPTURE_IS_MANDATORY);descriptor=function(position,notation,to){var firstSquareOfArea=16-32*position.turn,from=to-firstSquareOfArea;if(0!=(136&from))throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_NON_CAPTURING_PAWN_MOVE);if(0<=position.board[to])throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_NON_CAPTURING_PAWN_MOVE);var expectedFromContent=2*bt.PAWN+position.turn;{if(position.board[from]===expectedFromContent)return moveGeneration.isKingSafeAfterMove(position,from,to,-1);if(position.board[from]<0){from-=firstSquareOfArea;firstSquareOfArea=96*position.turn;if(firstSquareOfArea<=from&&from<24+firstSquareOfArea&&position.board[from]===expectedFromContent)return moveGeneration.isKingSafeAfterMove(position,from,to,-1)}}throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_NON_CAPTURING_PAWN_MOVE)}(position,notation,to)}if(!descriptor){observedCCS=position.turn===bt.WHITE?i18n.NOT_SAFE_FOR_WHITE_KING:i18n.NOT_SAFE_FOR_BLACK_KING;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,observedCCS)}if(to<8||112<=to){if(!m[12])throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.MISSING_PROMOTION);promotion=parsePieceSymbol(position,notation,m[12],expectedCCS,promotion);if(promotion===bt.PAWN||promotion===bt.KING&&position.variant!==bt.ANTICHESS)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_PROMOTED_PIECE,m[12]);if(descriptor=moveDescriptor.makePromotion(descriptor._from,descriptor._to,descriptor._movingPiece%2,promotion,descriptor._optionalPiece),expectedCCS&&!m[11])throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.MISSING_PROMOTION_SYMBOL)}else if(m[12])throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_PROMOTION)}if(expectedCCS){if(descriptor.isCapture()!==(m[6]||m[9])){observedCCS=descriptor.isCapture()?i18n.MISSING_CAPTURE_SYMBOL:i18n.INVALID_CAPTURE_SYMBOL;throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,observedCCS)}expectedCCS=getCheckCheckmateSymbol(position,descriptor),observedCCS=m[13]||"";if(expectedCCS!==observedCCS)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.WRONG_CHECK_CHECKMATE_SYMBOL,expectedCCS,observedCCS)}return descriptor}},{"../basetypes":1,"../exception":3,"../i18n":6,"../movedescriptor":8,"./attacks":16,"./fen":17,"./impl":18,"./legality":19,"./movegeneration":20}],22:[function(require,module,exports){"use strict";var bt=require("../basetypes"),exception=require("../exception"),i18n=require("../i18n"),fen=require("./fen"),legality=require("./legality"),moveGeneration=require("./movegeneration");exports.getNotation=function(position,descriptor,forceKxR){var res=descriptor.from();return descriptor.isCastling()?res+=forceKxR||position.variant===bt.CHESS960?descriptor.rookFrom():descriptor.to():res+=descriptor.to(),descriptor.isPromotion()&&(res+=descriptor.promotion()),res},exports.parseNotation=function(position,notation,toPiece){var m=/^([a-h][1-8])([a-h][1-8])([kqrbnp]?)$/.exec(notation);if(null===m)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.INVALID_UCI_NOTATION_SYNTAX);if(!legality.isLegal(position))throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_POSITION);var fromPiece,result=bt.squareFromString(m[1]),promotion=bt.squareFromString(m[2]),kxrSubstitutionApplied=!1,expectedRookFrom=null;position.variant===bt.CHESS960||toPiece||position.board[result]===bt.EMPTY||position.board[promotion]===bt.EMPTY||position.board[result]%2!=position.board[promotion]%2||(fromPiece=Math.floor(position.board[result]/2),toPiece=Math.floor(position.board[promotion]/2),fromPiece===bt.KING&&toPiece===bt.ROOK&&(kxrSubstitutionApplied=!0,expectedRookFrom=promotion,promotion=112*position.turn+(result<promotion?6:2)));result=moveGeneration.isMoveLegal(position,result,promotion);if(!result)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_UCI_MOVE);if("promotion"===result.type){promotion=bt.pieceFromString(m[3]);if(promotion<0||promotion===bt.PAWN||promotion===bt.KING&&position.variant!==bt.ANTICHESS)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_UCI_MOVE);result=result.build(promotion)}else if(""!==m[3])throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_UCI_MOVE);if(result.isCastling()){if(kxrSubstitutionApplied&&expectedRookFrom!==result._optionalSquare1)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_UCI_MOVE)}else if(kxrSubstitutionApplied)throw new exception.InvalidNotation(fen.getFEN(position,0,1),notation,i18n.ILLEGAL_UCI_MOVE);return result}},{"../basetypes":1,"../exception":3,"../i18n":6,"./fen":17,"./legality":19,"./movegeneration":20}]},{},[7])(7)});